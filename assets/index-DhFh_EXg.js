(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();/*! Capacitor: https://capacitorjs.com/ - MIT License */var me;(function(e){e.Unimplemented="UNIMPLEMENTED",e.Unavailable="UNAVAILABLE"})(me||(me={}));class _e extends Error{constructor(t,n,r){super(t),this.message=t,this.code=n,this.data=r}}const Rt=e=>{var t,n;return e!=null&&e.androidBridge?"android":!((n=(t=e==null?void 0:e.webkit)===null||t===void 0?void 0:t.messageHandlers)===null||n===void 0)&&n.bridge?"ios":"web"},Ut=e=>{const t=e.CapacitorCustomPlatform||null,n=e.Capacitor||{},r=n.Plugins=n.Plugins||{},o=()=>t!==null?t.name:Rt(e),i=()=>o()!=="web",s=p=>{const f=u.get(p);return!!(f!=null&&f.platforms.has(o())||l(p))},l=p=>{var f;return(f=n.PluginHeaders)===null||f===void 0?void 0:f.find(d=>d.name===p)},a=p=>e.console.error(p),u=new Map,c=(p,f={})=>{const d=u.get(p);if(d)return console.warn(`Capacitor plugin "${p}" already registered. Cannot register plugins twice.`),d.proxy;const g=o(),m=l(p);let h;const y=async()=>(!h&&g in f?h=typeof f[g]=="function"?h=await f[g]():h=f[g]:t!==null&&!h&&"web"in f&&(h=typeof f.web=="function"?h=await f.web():h=f.web),h),x=(k,b)=>{var I,$;if(m){const U=m==null?void 0:m.methods.find(N=>b===N.name);if(U)return U.rtype==="promise"?N=>n.nativePromise(p,b.toString(),N):(N,L)=>n.nativeCallback(p,b.toString(),N,L);if(k)return(I=k[b])===null||I===void 0?void 0:I.bind(k)}else{if(k)return($=k[b])===null||$===void 0?void 0:$.bind(k);throw new _e(`"${p}" plugin is not implemented on ${g}`,me.Unimplemented)}},B=k=>{let b;const I=(...$)=>{const U=y().then(N=>{const L=x(N,k);if(L){const S=L(...$);return b=S==null?void 0:S.remove,S}else throw new _e(`"${p}.${k}()" is not implemented on ${g}`,me.Unimplemented)});return k==="addListener"&&(U.remove=async()=>b()),U};return I.toString=()=>`${k.toString()}() { [capacitor code] }`,Object.defineProperty(I,"name",{value:k,writable:!1,configurable:!1}),I},C=B("addListener"),E=B("removeListener"),P=(k,b)=>{const I=C({eventName:k},b),$=async()=>{const N=await I;E({eventName:k,callbackId:N},b)},U=new Promise(N=>I.then(()=>N({remove:$})));return U.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await $()},U},w=new Proxy({},{get(k,b){switch(b){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return m?P:C;case"removeListener":return E;default:return B(b)}}});return r[p]=w,u.set(p,{name:p,proxy:w,platforms:new Set([...Object.keys(f),...m?[g]:[]])}),w};return n.convertFileSrc||(n.convertFileSrc=p=>p),n.getPlatform=o,n.handleError=a,n.isNativePlatform=i,n.isPluginAvailable=s,n.registerPlugin=c,n.Exception=_e,n.DEBUG=!!n.DEBUG,n.isLoggingEnabled=!!n.isLoggingEnabled,n},At=e=>e.Capacitor=Ut(e),q=At(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),ye=q.registerPlugin;class xt{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(t,n){let r=!1;this.listeners[t]||(this.listeners[t]=[],r=!0),this.listeners[t].push(n);const i=this.windowListeners[t];i&&!i.registered&&this.addWindowListener(i),r&&this.sendRetainedArgumentsForEvent(t);const s=async()=>this.removeListener(t,n);return Promise.resolve({remove:s})}async removeAllListeners(){this.listeners={};for(const t in this.windowListeners)this.removeWindowListener(this.windowListeners[t]);this.windowListeners={}}notifyListeners(t,n,r){const o=this.listeners[t];if(!o){if(r){let i=this.retainedEventArguments[t];i||(i=[]),i.push(n),this.retainedEventArguments[t]=i}return}o.forEach(i=>i(n))}hasListeners(t){var n;return!!(!((n=this.listeners[t])===null||n===void 0)&&n.length)}registerWindowListener(t,n){this.windowListeners[n]={registered:!1,windowEventName:t,pluginEventName:n,handler:r=>{this.notifyListeners(n,r)}}}unimplemented(t="not implemented"){return new q.Exception(t,me.Unimplemented)}unavailable(t="not available"){return new q.Exception(t,me.Unavailable)}async removeListener(t,n){const r=this.listeners[t];if(!r)return;const o=r.indexOf(n);this.listeners[t].splice(o,1),this.listeners[t].length||this.removeWindowListener(this.windowListeners[t])}addWindowListener(t){window.addEventListener(t.windowEventName,t.handler),t.registered=!0}removeWindowListener(t){t&&(window.removeEventListener(t.windowEventName,t.handler),t.registered=!1)}sendRetainedArgumentsForEvent(t){const n=this.retainedEventArguments[t];n&&(delete this.retainedEventArguments[t],n.forEach(r=>{this.notifyListeners(t,r)}))}}const rt=e=>encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),ot=e=>e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class Mt extends xt{async getCookies(){const t=document.cookie,n={};return t.split(";").forEach(r=>{if(r.length<=0)return;let[o,i]=r.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");o=ot(o).trim(),i=ot(i).trim(),n[o]=i}),n}async setCookie(t){try{const n=rt(t.key),r=rt(t.value),o=`; expires=${(t.expires||"").replace("expires=","")}`,i=(t.path||"/").replace("path=",""),s=t.url!=null&&t.url.length>0?`domain=${t.url}`:"";document.cookie=`${n}=${r||""}${o}; path=${i}; ${s};`}catch(n){return Promise.reject(n)}}async deleteCookie(t){try{document.cookie=`${t.key}=; Max-Age=0`}catch(n){return Promise.reject(n)}}async clearCookies(){try{const t=document.cookie.split(";")||[];for(const n of t)document.cookie=n.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(t){return Promise.reject(t)}}async clearAllCookies(){try{await this.clearCookies()}catch(t){return Promise.reject(t)}}}ye("CapacitorCookies",{web:()=>new Mt});const Dt=async e=>new Promise((t,n)=>{const r=new FileReader;r.onload=()=>{const o=r.result;t(o.indexOf(",")>=0?o.split(",")[1]:o)},r.onerror=o=>n(o),r.readAsDataURL(e)}),Zt=(e={})=>{const t=Object.keys(e);return Object.keys(e).map(o=>o.toLocaleLowerCase()).reduce((o,i,s)=>(o[i]=e[t[s]],o),{})},jt=(e,t=!0)=>e?Object.entries(e).reduce((r,o)=>{const[i,s]=o;let l,a;return Array.isArray(s)?(a="",s.forEach(u=>{l=t?encodeURIComponent(u):u,a+=`${i}=${l}&`}),a.slice(0,-1)):(l=t?encodeURIComponent(s):s,a=`${i}=${l}`),`${r}&${a}`},"").substr(1):null,zt=(e,t={})=>{const n=Object.assign({method:e.method||"GET",headers:e.headers},t),o=Zt(e.headers)["content-type"]||"";if(typeof e.data=="string")n.body=e.data;else if(o.includes("application/x-www-form-urlencoded")){const i=new URLSearchParams;for(const[s,l]of Object.entries(e.data||{}))i.set(s,l);n.body=i.toString()}else if(o.includes("multipart/form-data")||e.data instanceof FormData){const i=new FormData;if(e.data instanceof FormData)e.data.forEach((l,a)=>{i.append(a,l)});else for(const l of Object.keys(e.data))i.append(l,e.data[l]);n.body=i;const s=new Headers(n.headers);s.delete("content-type"),n.headers=s}else(o.includes("application/json")||typeof e.data=="object")&&(n.body=JSON.stringify(e.data));return n};class qt extends xt{async request(t){const n=zt(t,t.webFetchExtra),r=jt(t.params,t.shouldEncodeUrlParams),o=r?`${t.url}?${r}`:t.url,i=await fetch(o,n),s=i.headers.get("content-type")||"";let{responseType:l="text"}=i.ok?t:{};s.includes("application/json")&&(l="json");let a,u;switch(l){case"arraybuffer":case"blob":u=await i.blob(),a=await Dt(u);break;case"json":a=await i.json();break;case"document":case"text":default:a=await i.text()}const c={};return i.headers.forEach((p,f)=>{c[f]=p}),{data:a,headers:c,status:i.status,url:i.url}}async get(t){return this.request(Object.assign(Object.assign({},t),{method:"GET"}))}async post(t){return this.request(Object.assign(Object.assign({},t),{method:"POST"}))}async put(t){return this.request(Object.assign(Object.assign({},t),{method:"PUT"}))}async patch(t){return this.request(Object.assign(Object.assign({},t),{method:"PATCH"}))}async delete(t){return this.request(Object.assign(Object.assign({},t),{method:"DELETE"}))}}ye("CapacitorHttp",{web:()=>new qt});const Ht="modulepreload",Wt=function(e){return"/"+e},it={},Je=function(t,n,r){let o=Promise.resolve();if(n&&n.length>0){let s=function(u){return Promise.all(u.map(c=>Promise.resolve(c).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),a=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));o=s(n.map(u=>{if(u=Wt(u),u in it)return;it[u]=!0;const c=u.endsWith(".css"),p=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${p}`))return;const f=document.createElement("link");if(f.rel=c?"stylesheet":Ht,c||(f.as="script"),f.crossOrigin="",f.href=u,a&&f.setAttribute("nonce",a),document.head.appendChild(f),c)return new Promise((d,g)=>{f.addEventListener("load",d),f.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${u}`)))})}))}function i(s){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=s,window.dispatchEvent(l),!l.defaultPrevented)throw s}return o.then(s=>{for(const l of s||[])l.status==="rejected"&&i(l.reason);return t().catch(i)})};var J;(function(e){e.Heavy="HEAVY",e.Medium="MEDIUM",e.Light="LIGHT"})(J||(J={}));var st;(function(e){e.Success="SUCCESS",e.Warning="WARNING",e.Error="ERROR"})(st||(st={}));const Y=ye("Haptics",{web:()=>Je(()=>import("./web-BZOZr_Qv.js"),[]).then(e=>new e.HapticsWeb)}),xe=document.getElementById("toast"),G=document.getElementById("sidebar");let ie=0,Le=0,Pe=0,$e=0,ce=!1,ue=!1;const at=60,Et=60,wt=80,Jt=80;function ge(){G==null||G.classList.toggle("open")}function Xt(e){const t=e.touches[0];ie=t.clientX,Le=t.clientY,ce=!1,ue=!1,G&&(!G.classList.contains("open")&&ie>window.innerWidth-Et||G.classList.contains("open")&&ie<G.offsetWidth+wt)&&(ce=!0,ue=!0)}function Yt(e){if(!ue||e.touches.length===0)return;const t=e.touches[0];Pe=t.clientX,$e=t.clientY;const n=Pe-ie,r=$e-Le;Math.abs(n)>Math.abs(r)&&Math.abs(n)>10&&ce&&e.preventDefault()}function Gt(){if(!ce||!ue||!G){ce=!1,ue=!1;return}const e=Pe-ie,t=$e-Le;let n=!1;Math.abs(t)<Jt&&(!G.classList.contains("open")&&e<-at&&ie>window.innerWidth-Et||G.classList.contains("open")&&e>at&&ie<G.offsetWidth+wt)&&(ge(),n=!0),n&&q.isNativePlatform()&&Y.impact({style:J.Light}),ce=!1,ue=!1,ie=0,Le=0,Pe=0,$e=0}function te(e,t=!1){if(!xe){console.error("Toast element not found");return}xe.textContent=e,xe.className="status-toast "+(t?"toast-error":"toast-success"),xe.style.opacity="1",setTimeout(()=>{xe.style.opacity="0"},3e3)}function ne(e,t){e&&(e.style.display=t?"block":"none")}function Kt(e,t){const n=document.getElementById("dashboardApp"),r=document.getElementById("appTitle");n&&(n.style.display="none");let o="Novelist Tools",i=!1;for(const s in t){const l=t[s],a=document.getElementById(l.elementId);a&&(s===e?(a.style.display="block",o=l.title,i=!0):a.style.display="none")}return r&&(r.textContent=o),G&&G.classList.contains("open")&&ge(),i}function re(e=!1,t){const n=document.getElementById("dashboardApp"),r=document.getElementById("appTitle");n&&(n.style.display="block");for(const i in t){const s=t[i],l=document.getElementById(s.elementId);l&&(l.style.display="none")}r&&(r.textContent="Novelist Tools"),G&&G.classList.contains("open")&&ge();const o="#dashboard";if(!e&&window.location.hash!==o){const i=window.location.protocol==="blob:"?null:o;history.pushState({view:"dashboard"},"Novelist Tools Dashboard",i),console.log("UI: Pushed history state for Dashboard. URL used:",i===null?"null (blob)":i)}else e&&console.log("UI: Show Dashboard from popstate, hash is:",window.location.hash);sessionStorage.removeItem("activeToolId")}function Ae(e,t=!1,n){if(!Kt(e,n)){if(console.warn(`Tool with ID '${e}' not found or failed to launch. Showing dashboard.`),re(t,n),!t){const s="#dashboard",l=window.location.protocol==="blob:"?null:s;window.location.hash!==s&&l!==null&&history.replaceState({view:"dashboard"},"Novelist Tools Dashboard",l)}return}const o=n[e],i=`#tool-${e}`;if(!t&&window.location.hash!==i)if(o){const s=window.location.protocol==="blob:"?null:i;history.pushState({view:"tool",toolId:e},o.title,s),console.log(`UI: Pushed history state for tool '${e}'. URL used:`,s===null?"null (blob)":s)}else console.error(`Tool info not found for ${e} during pushState, though displayTool succeeded.`);else t&&console.log(`UI: Launch app '${e}' from popstate, hash is:`,window.location.hash);sessionStorage.setItem("activeToolId",e)}function Vt(e){e.CapacitorUtils.Synapse=new Proxy({},{get(t,n){return new Proxy({},{get(r,o){return(i,s,l)=>{const a=e.Capacitor.Plugins[n];if(a===void 0){l(new Error(`Capacitor plugin ${n} not found`));return}if(typeof a[o]!="function"){l(new Error(`Method ${o} not found in Capacitor plugin ${n}`));return}(async()=>{try{const u=await a[o](i);s(u)}catch(u){l(u)}})()}}})}})}function Qt(e){e.CapacitorUtils.Synapse=new Proxy({},{get(t,n){return e.cordova.plugins[n]}})}function en(e=!1){typeof window>"u"||(window.CapacitorUtils=window.CapacitorUtils||{},window.Capacitor!==void 0&&!e?Vt(window):window.cordova!==void 0&&Qt(window))}var Me;(function(e){e.Documents="DOCUMENTS",e.Data="DATA",e.Library="LIBRARY",e.Cache="CACHE",e.External="EXTERNAL",e.ExternalStorage="EXTERNAL_STORAGE",e.ExternalCache="EXTERNAL_CACHE",e.LibraryNoCloud="LIBRARY_NO_CLOUD",e.Temporary="TEMPORARY"})(Me||(Me={}));var lt;(function(e){e.UTF8="utf8",e.ASCII="ascii",e.UTF16="utf16"})(lt||(lt={}));const tn=ye("Filesystem",{web:()=>Je(()=>import("./web-DxxberHc.js"),[]).then(e=>new e.FilesystemWeb)});en();function nn(){if(typeof process>"u"){var e=typeof window<"u"?window:{},t=5e3,n=Date.now(),r=!1;e.document.addEventListener("deviceready",function(){console.log("Ionic Native: deviceready event fired after "+(Date.now()-n)+" ms"),r=!0}),setTimeout(function(){!r&&e.cordova&&console.warn("Ionic Native: deviceready did not fire within "+t+"ms. This can happen when plugins are in an inconsistent state. Try removing plugins from plugins/ and reinstalling them.")},t)}}var De=function(e,t){return De=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,r){n.__proto__=r}||function(n,r){for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(n[o]=r[o])},De(e,t)};function Xe(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");De(e,t);function n(){this.constructor=e}e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)}function rn(e,t,n,r){function o(i){return i instanceof n?i:new n(function(s){s(i)})}return new(n||(n=Promise))(function(i,s){function l(c){try{u(r.next(c))}catch(p){s(p)}}function a(c){try{u(r.throw(c))}catch(p){s(p)}}function u(c){c.done?i(c.value):o(c.value).then(l,a)}u((r=r.apply(e,t||[])).next())})}function kt(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},r,o,i,s=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return s.next=l(0),s.throw=l(1),s.return=l(2),typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function l(u){return function(c){return a([u,c])}}function a(u){if(r)throw new TypeError("Generator is already executing.");for(;s&&(s=0,u[0]&&(n=0)),n;)try{if(r=1,o&&(i=u[0]&2?o.return:u[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,u[1])).done)return i;switch(o=0,i&&(u=[u[0]&2,i.value]),u[0]){case 0:case 1:i=u;break;case 4:return n.label++,{value:u[1],done:!1};case 5:n.label++,o=u[1],u=[0];continue;case 7:u=n.ops.pop(),n.trys.pop();continue;default:if(i=n.trys,!(i=i.length>0&&i[i.length-1])&&(u[0]===6||u[0]===2)){n=0;continue}if(u[0]===3&&(!i||u[1]>i[0]&&u[1]<i[3])){n.label=u[1];break}if(u[0]===6&&n.label<i[1]){n.label=i[1],i=u;break}if(i&&n.label<i[2]){n.label=i[2],n.ops.push(u);break}i[2]&&n.ops.pop(),n.trys.pop();continue}u=t.call(e,n)}catch(c){u=[6,c],o=0}finally{r=i=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function Ie(e){var t=typeof Symbol=="function"&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function Ce(e,t){var n=typeof Symbol=="function"&&e[Symbol.iterator];if(!n)return e;var r=n.call(e),o,i=[],s;try{for(;(t===void 0||t-- >0)&&!(o=r.next()).done;)i.push(o.value)}catch(l){s={error:l}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(s)throw s.error}}return i}function Fe(e,t,n){if(n||arguments.length===2)for(var r=0,o=t.length,i;r<o;r++)(i||!(r in t))&&(i||(i=Array.prototype.slice.call(t,0,r)),i[r]=t[r]);return e.concat(i||Array.prototype.slice.call(t))}function pe(e){return this instanceof pe?(this.v=e,this):new pe(e)}function on(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=n.apply(e,t||[]),o,i=[];return o=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),l("next"),l("throw"),l("return",s),o[Symbol.asyncIterator]=function(){return this},o;function s(d){return function(g){return Promise.resolve(g).then(d,p)}}function l(d,g){r[d]&&(o[d]=function(m){return new Promise(function(h,y){i.push([d,m,h,y])>1||a(d,m)})},g&&(o[d]=g(o[d])))}function a(d,g){try{u(r[d](g))}catch(m){f(i[0][3],m)}}function u(d){d.value instanceof pe?Promise.resolve(d.value.v).then(c,p):f(i[0][2],d)}function c(d){a("next",d)}function p(d){a("throw",d)}function f(d,g){d(g),i.shift(),i.length&&a(i[0][0],i[0][1])}}function sn(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],n;return t?t.call(e):(e=typeof Ie=="function"?Ie(e):e[Symbol.iterator](),n={},r("next"),r("throw"),r("return"),n[Symbol.asyncIterator]=function(){return this},n);function r(i){n[i]=e[i]&&function(s){return new Promise(function(l,a){s=e[i](s),o(l,a,s.done,s.value)})}}function o(i,s,l,a){Promise.resolve(a).then(function(u){i({value:u,done:l})},s)}}function D(e){return typeof e=="function"}function an(e){var t=function(r){Error.call(r),r.stack=new Error().stack},n=e(t);return n.prototype=Object.create(Error.prototype),n.prototype.constructor=n,n}var Oe=an(function(e){return function(n){e(this),this.message=n?n.length+` errors occurred during unsubscription:
`+n.map(function(r,o){return o+1+") "+r.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=n}});function ct(e,t){if(e){var n=e.indexOf(t);0<=n&&e.splice(n,1)}}var Ye=function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,n,r,o,i;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var l=Ie(s),a=l.next();!a.done;a=l.next()){var u=a.value;u.remove(this)}}catch(m){t={error:m}}finally{try{a&&!a.done&&(n=l.return)&&n.call(l)}finally{if(t)throw t.error}}else s.remove(this);var c=this.initialTeardown;if(D(c))try{c()}catch(m){i=m instanceof Oe?m.errors:[m]}var p=this._finalizers;if(p){this._finalizers=null;try{for(var f=Ie(p),d=f.next();!d.done;d=f.next()){var g=d.value;try{ut(g)}catch(m){i=i??[],m instanceof Oe?i=Fe(Fe([],Ce(i)),Ce(m.errors)):i.push(m)}}}catch(m){r={error:m}}finally{try{d&&!d.done&&(o=f.return)&&o.call(f)}finally{if(r)throw r.error}}}if(i)throw new Oe(i)}},e.prototype.add=function(t){var n;if(t&&t!==this)if(this.closed)ut(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(n=this._finalizers)!==null&&n!==void 0?n:[]).push(t)}},e.prototype._hasParent=function(t){var n=this._parentage;return n===t||Array.isArray(n)&&n.includes(t)},e.prototype._addParent=function(t){var n=this._parentage;this._parentage=Array.isArray(n)?(n.push(t),n):n?[n,t]:t},e.prototype._removeParent=function(t){var n=this._parentage;n===t?this._parentage=null:Array.isArray(n)&&ct(n,t)},e.prototype.remove=function(t){var n=this._finalizers;n&&ct(n,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}();Ye.EMPTY;function It(e){return e instanceof Ye||e&&"closed"in e&&D(e.remove)&&D(e.add)&&D(e.unsubscribe)}function ut(e){D(e)?e():e.unsubscribe()}var ln={Promise:void 0},cn={setTimeout:function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return setTimeout.apply(void 0,Fe([e,t],Ce(n)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function Ct(e){cn.setTimeout(function(){throw e})}function dt(){}function un(e){e()}var Ge=function(e){Xe(t,e);function t(n){var r=e.call(this)||this;return r.isStopped=!1,n?(r.destination=n,It(n)&&n.add(r)):r.destination=pn,r}return t.create=function(n,r,o){return new Ze(n,r,o)},t.prototype.next=function(n){this.isStopped||this._next(n)},t.prototype.error=function(n){this.isStopped||(this.isStopped=!0,this._error(n))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(n){this.destination.next(n)},t.prototype._error=function(n){try{this.destination.error(n)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(Ye),dn=function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var n=this.partialObserver;if(n.next)try{n.next(t)}catch(r){Be(r)}},e.prototype.error=function(t){var n=this.partialObserver;if(n.error)try{n.error(t)}catch(r){Be(r)}else Be(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(n){Be(n)}},e}(),Ze=function(e){Xe(t,e);function t(n,r,o){var i=e.call(this)||this,s;return D(n)||!n?s={next:n??void 0,error:r??void 0,complete:o??void 0}:s=n,i.destination=new dn(s),i}return t}(Ge);function Be(e){Ct(e)}function fn(e){throw e}var pn={closed:!0,next:dt,error:fn,complete:dt},Ke=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function hn(e){return e}function mn(e){return e.length===0?hn:e.length===1?e[0]:function(n){return e.reduce(function(r,o){return o(r)},n)}}var ae=function(){function e(t){t&&(this._subscribe=t)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(t,n,r){var o=this,i=yn(t)?t:new Ze(t,n,r);return un(function(){var s=o,l=s.operator,a=s.source;i.add(l?l.call(i,a):a?o._subscribe(i):o._trySubscribe(i))}),i},e.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(n){t.error(n)}},e.prototype.forEach=function(t,n){var r=this;return n=ft(n),new n(function(o,i){var s=new Ze({next:function(l){try{t(l)}catch(a){i(a),s.unsubscribe()}},error:i,complete:o});r.subscribe(s)})},e.prototype._subscribe=function(t){var n;return(n=this.source)===null||n===void 0?void 0:n.subscribe(t)},e.prototype[Ke]=function(){return this},e.prototype.pipe=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return mn(t)(this)},e.prototype.toPromise=function(t){var n=this;return t=ft(t),new t(function(r,o){var i;n.subscribe(function(s){return i=s},function(s){return o(s)},function(){return r(i)})})},e.create=function(t){return new e(t)},e}();function ft(e){var t;return(t=e??ln.Promise)!==null&&t!==void 0?t:Promise}function gn(e){return e&&D(e.next)&&D(e.error)&&D(e.complete)}function yn(e){return e&&e instanceof Ge||gn(e)&&It(e)}function vn(e){return D(e==null?void 0:e.lift)}function Bt(e){return function(t){if(vn(t))return t.lift(function(n){try{return e(n,this)}catch(r){this.error(r)}});throw new TypeError("Unable to lift unknown Observable type")}}function je(e,t,n,r,o){return new bn(e,t,n,r,o)}var bn=function(e){Xe(t,e);function t(n,r,o,i,s,l){var a=e.call(this,n)||this;return a.onFinalize=s,a.shouldUnsubscribe=l,a._next=r?function(u){try{r(u)}catch(c){n.error(c)}}:e.prototype._next,a._error=i?function(u){try{i(u)}catch(c){n.error(c)}finally{this.unsubscribe()}}:e.prototype._error,a._complete=o?function(){try{o()}catch(u){n.error(u)}finally{this.unsubscribe()}}:e.prototype._complete,a}return t.prototype.unsubscribe=function(){var n;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var r=this.closed;e.prototype.unsubscribe.call(this),!r&&((n=this.onFinalize)===null||n===void 0||n.call(this))}},t}(Ge),St=function(e){return e&&typeof e.length=="number"&&typeof e!="function"};function xn(e){return D(e==null?void 0:e.then)}function En(e){return D(e[Ke])}function wn(e){return Symbol.asyncIterator&&D(e==null?void 0:e[Symbol.asyncIterator])}function kn(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function In(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Cn=In();function Bn(e){return D(e==null?void 0:e[Cn])}function Sn(e){return on(this,arguments,function(){var n,r,o,i;return kt(this,function(s){switch(s.label){case 0:n=e.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,pe(n.read())];case 3:return r=s.sent(),o=r.value,i=r.done,i?[4,pe(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,pe(o)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return n.releaseLock(),[7];case 10:return[2]}})})}function Ln(e){return D(e==null?void 0:e.getReader)}function Ve(e){if(e instanceof ae)return e;if(e!=null){if(En(e))return Pn(e);if(St(e))return $n(e);if(xn(e))return Fn(e);if(wn(e))return Lt(e);if(Bn(e))return Nn(e);if(Ln(e))return Tn(e)}throw kn(e)}function Pn(e){return new ae(function(t){var n=e[Ke]();if(D(n.subscribe))return n.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function $n(e){return new ae(function(t){for(var n=0;n<e.length&&!t.closed;n++)t.next(e[n]);t.complete()})}function Fn(e){return new ae(function(t){e.then(function(n){t.closed||(t.next(n),t.complete())},function(n){return t.error(n)}).then(null,Ct)})}function Nn(e){return new ae(function(t){var n,r;try{for(var o=Ie(e),i=o.next();!i.done;i=o.next()){var s=i.value;if(t.next(s),t.closed)return}}catch(l){n={error:l}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}t.complete()})}function Lt(e){return new ae(function(t){_n(e,t).catch(function(n){return t.error(n)})})}function Tn(e){return Lt(Sn(e))}function _n(e,t){var n,r,o,i;return rn(this,void 0,void 0,function(){var s,l;return kt(this,function(a){switch(a.label){case 0:a.trys.push([0,5,6,11]),n=sn(e),a.label=1;case 1:return[4,n.next()];case 2:if(r=a.sent(),!!r.done)return[3,4];if(s=r.value,t.next(s),t.closed)return[2];a.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return l=a.sent(),o={error:l},[3,11];case 6:return a.trys.push([6,,9,10]),r&&!r.done&&(i=n.return)?[4,i.call(n)]:[3,8];case 7:a.sent(),a.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function Pt(e,t){return Bt(function(n,r){var o=0;n.subscribe(je(r,function(i){r.next(e.call(t,i,o++))}))})}var On=Array.isArray;function Rn(e,t){return On(t)?e.apply(void 0,Fe([],Ce(t))):e(t)}function Un(e){return Pt(function(t){return Rn(e,t)})}function An(e,t,n,r,o,i,s,l){var a=[],u=0,c=0,p=!1,f=function(){p&&!a.length&&!u&&t.complete()},d=function(m){return u<r?g(m):a.push(m)},g=function(m){u++;var h=!1;Ve(n(m,c++)).subscribe(je(t,function(y){t.next(y)},function(){h=!0},void 0,function(){if(h)try{u--;for(var y=function(){var x=a.shift();s||g(x)};a.length&&u<r;)y();f()}catch(x){t.error(x)}}))};return e.subscribe(je(t,d,function(){p=!0,f()})),function(){}}function $t(e,t,n){return n===void 0&&(n=1/0),D(t)?$t(function(r,o){return Pt(function(i,s){return t(r,i,o,s)})(Ve(e(r,o)))},n):(typeof t=="number"&&(n=t),Bt(function(r,o){return An(r,o,e,n)}))}var Mn=["addListener","removeListener"],Dn=["addEventListener","removeEventListener"],Zn=["on","off"];function ze(e,t,n,r){if(D(n)&&(r=n,n=void 0),r)return ze(e,t,n).pipe(Un(r));var o=Ce(qn(e)?Dn.map(function(l){return function(a){return e[l](t,a,n)}}):jn(e)?Mn.map(pt(e,t)):zn(e)?Zn.map(pt(e,t)):[],2),i=o[0],s=o[1];if(!i&&St(e))return $t(function(l){return ze(l,t,n)})(Ve(e));if(!i)throw new TypeError("Invalid event target");return new ae(function(l){var a=function(){for(var u=[],c=0;c<arguments.length;c++)u[c]=arguments[c];return l.next(1<u.length?u:u[0])};return i(a),function(){return s(a)}})}function pt(e,t){return function(n){return function(r){return e[n](t,r)}}}function jn(e){return D(e.addListener)&&D(e.removeListener)}function zn(e){return D(e.on)&&D(e.off)}function qn(e){return D(e.addEventListener)&&D(e.removeEventListener)}var Hn={error:"cordova_not_available"},Wn={error:"plugin_not_installed"};function Ft(e){var t=function(){if(Promise)return new Promise(function(i,s){e(i,s)});console.error("No Promise support or polyfill found. To enable Ionic Native support, please add the es6-promise polyfill before this script, or run with a library like Angular or on a recent browser.")};if(typeof window<"u"&&window.angular){var n=window.document,r=window.angular.element(n.querySelector("[ng-app]")||n.body).injector();if(r){var o=r.get("$q");return o(function(i,s){e(i,s)})}console.warn("Angular 1 was detected but $q couldn't be retrieved. This is usually when the app is not bootstrapped on the html or body tag. Falling back to native promises which won't trigger an automatic digest when promises resolve.")}return t()}function Jn(e,t,n,r){r===void 0&&(r={});var o,i,s=Ft(function(l,a){r.destruct?o=se(e,t,n,r,function(){for(var u=[],c=0;c<arguments.length;c++)u[c]=arguments[c];return l(u)},function(){for(var u=[],c=0;c<arguments.length;c++)u[c]=arguments[c];return a(u)}):o=se(e,t,n,r,l,a),i=a});return o&&o.error&&(s.catch(function(){}),typeof i=="function"&&i(o.error)),s}function Xn(e,t,n,r){return r===void 0&&(r={}),Ft(function(o,i){var s=se(e,t,n,r);s?s.error?i(s.error):s.then&&s.then(o).catch(i):i({error:"unexpected_error"})})}function Yn(e,t,n,r){return r===void 0&&(r={}),new ae(function(o){var i;return r.destruct?i=se(e,t,n,r,function(){for(var s=[],l=0;l<arguments.length;l++)s[l]=arguments[l];return o.next(s)},function(){for(var s=[],l=0;l<arguments.length;l++)s[l]=arguments[l];return o.error(s)}):i=se(e,t,n,r,o.next.bind(o),o.error.bind(o)),i&&i.error&&(o.error(i.error),o.complete()),function(){try{if(r.clearFunction)return r.clearWithArgs?se(e,r.clearFunction,n,r,o.next.bind(o),o.error.bind(o)):se(e,r.clearFunction,[])}catch(s){console.warn("Unable to clear the previous observable watch for",e.constructor.getPluginName(),t),console.warn(s)}}})}function Gn(e,t){return t=typeof window<"u"&&t?_t(window,t):t||(typeof window<"u"?window:{}),ze(t,e)}function Nt(e,t,n){var r,o;typeof e=="string"?r=e:(r=e.constructor.getPluginRef(),n=e.constructor.getPluginName(),o=e.constructor.getPluginInstallName());var i=Tt(r);return!i||t&&typeof i[t]>"u"?typeof window>"u"||!window.cordova?(Qn(n,t),Hn):(Vn(n,o,t),Wn):!0}function Kn(e,t,n,r){if(t===void 0&&(t={}),t.sync)return e;if(t.callbackOrder==="reverse")e.unshift(r),e.unshift(n);else if(t.callbackStyle==="node")e.push(function(l,a){l?r(l):n(a)});else if(t.callbackStyle==="object"&&t.successName&&t.errorName){var o={};o[t.successName]=n,o[t.errorName]=r,e.push(o)}else if(typeof t.successIndex<"u"||typeof t.errorIndex<"u"){var i=function(){t.successIndex>e.length?e[t.successIndex]=n:e.splice(t.successIndex,0,n)},s=function(){t.errorIndex>e.length?e[t.errorIndex]=r:e.splice(t.errorIndex,0,r)};t.successIndex>t.errorIndex?(s(),i()):(i(),s())}else e.push(n),e.push(r);return e}function se(e,t,n,r,o,i){r===void 0&&(r={}),n=Kn(n,r,o,i);var s=Nt(e,t);if(s===!0){var l=Tt(e.constructor.getPluginRef());return l[t].apply(l,n)}else return s}function Tt(e){return typeof window<"u"?_t(window,e):null}function _t(e,t){for(var n=t.split("."),r=e,o=0;o<n.length;o++){if(!r)return null;r=r[n[o]]}return r}function Vn(e,t,n){console.warn(n?"Native: tried calling "+e+"."+n+", but the "+e+" plugin is not installed.":"Native: tried accessing the "+e+" plugin but it's not installed."),t&&console.warn("Install the "+e+" plugin: 'ionic cordova plugin add "+t+"'")}function Qn(e,t){typeof process>"u"&&console.warn(t?"Native: tried calling "+e+"."+t+", but Cordova is not available. Make sure to include cordova.js or run in a device/simulator":"Native: tried accessing the "+e+" plugin but Cordova is not available. Make sure to include cordova.js or run in a device/simulator")}var er=function(e,t,n){return n===void 0&&(n={}),function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];return n.sync?se(e,t,r,n):n.observable?Yn(e,t,r,n):n.eventObservable&&n.event?Gn(n.event,n.element):n.otherPromise?Xn(e,t,r,n):Jn(e,t,r,n)}};function tr(e,t){for(var n=t.split("."),r=e,o=0;o<n.length;o++){if(!r)return null;r=r[n[o]]}return r}var nr=function(){function e(){}return e.installed=function(){var t=Nt(this.pluginRef)===!0;return t},e.getPlugin=function(){return typeof window<"u"?tr(window,this.pluginRef):null},e.getPluginName=function(){var t=this.pluginName;return t},e.getPluginRef=function(){var t=this.pluginRef;return t},e.getPluginInstallName=function(){var t=this.plugin;return t},e.getSupportedPlatforms=function(){var t=this.platforms;return t},e.pluginName="",e.pluginRef="",e.plugin="",e.repo="",e.platforms=[],e.install="",e}();function Se(e,t,n,r){return er(e,t,n).apply(this,r)}nn();var rr=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var i in o)Object.prototype.hasOwnProperty.call(o,i)&&(r[i]=o[i])},e(t,n)};return function(t,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");e(t,n);function r(){this.constructor=t}t.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}(),or=function(e){rr(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t.prototype.open=function(n,r){return Se(this,"open",{callbackStyle:"object",successName:"success",errorName:"error"},arguments)},t.prototype.uninstall=function(n){return Se(this,"uninstall",{callbackStyle:"object",successName:"success",errorName:"error"},arguments)},t.prototype.appIsInstalled=function(n){return Se(this,"appIsInstalled",{callbackStyle:"object",successName:"success",errorName:"error"},arguments)},t.prototype.showOpenWithDialog=function(n,r){return Se(this,"showOpenWithDialog",{callbackStyle:"object",successName:"success",errorName:"error"},arguments)},t.pluginName="FileOpener",t.plugin="cordova-plugin-file-opener2",t.pluginRef="cordova.plugins.fileOpener2",t.repo="https://github.com/pwlin/cordova-plugin-file-opener2",t.platforms=["Android","iOS","Windows","Windows Phone 8"],t}(nr),Re=new or;async function Ne(e,t,n,r){if(!q.isNativePlatform())return console.log("saveBlobNative: Not on a native platform. Skipping native save."),!1;const o=`Downloads/${t}`;console.log(`saveBlobNative: Attempting to save "${t}" natively to app's external directory: "${o}" with MIME type "${n}".`);try{const i=await e.arrayBuffer(),s=new Uint8Array(i);let l="";for(let c=0;c<s.byteLength;c++)l+=String.fromCharCode(s[c]);const a=btoa(l);console.log("saveBlobNative: Converted blob to base64. Attempting Filesystem.writeFile to Directory.External.");const u=await tn.writeFile({path:o,data:a,directory:Me.External,recursive:!0});console.log("saveBlobNative: File saved successfully to app external directory. URI:",u.uri),r(`File saved: ${t} (in app folder/Downloads)`,!1);try{console.log(`Attempting to open file: ${u.uri} with MIME: ${n}`),Re&&typeof Re.open=="function"?(await Re.open(u.uri,n),console.log("FileOpener.open call succeeded.")):(console.warn("FileOpener or FileOpener.open is not available. Skipping open."),r("File saved. Opener not available.",!1))}catch(c){console.warn("Could not open file automatically with FileOpener:",c);let p="Could not auto-open file";c&&c.message&&(p+=`: ${c.message}`),r(p,!0)}return!0}catch(i){console.error("saveBlobNative: Capacitor Filesystem save error:",i);let s="Unknown error during save";return i instanceof Error?s=i.message:typeof i=="string"?s=i:i&&typeof i.message=="string"&&(s=i.message),r(`Error saving file natively: ${s}`,!0),!1}}async function ve(e,t,n,r){if(!await Ne(e,t,n,r)){console.log(`triggerDownload: Native save failed or not native platform. Falling back to web download for "${t}".`);try{const i=URL.createObjectURL(e),s=document.createElement("a");s.href=i,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),r(`Download started: ${t}`,!1)}catch(i){console.error("triggerDownload: Web download fallback error:",i),r(`Error during web download: ${i.message||"Unknown error"}`,!0)}}}function ir(e){return new Promise((t,n)=>{const r=new FileReader;r.onload=()=>t(r.result),r.onerror=()=>n(new Error("Failed to read file")),r.readAsArrayBuffer(e)})}function sr(e,t){const n=document.getElementById("epubUpload"),r=document.getElementById("epubFileName"),o=document.getElementById("clearEpubUpload"),i=document.getElementById("splitBtn"),s=document.getElementById("modeSelect"),l=document.getElementById("groupSizeGroup"),a=document.getElementById("statusMessage"),u=document.querySelector("#splitterApp .download-section"),c=document.getElementById("downloadLink"),p=document.querySelector('label[for="chapterPattern"]'),f=p==null?void 0:p.querySelector(".tooltip-trigger"),d=document.getElementById("splitterChapterSelectionArea"),g=document.getElementById("splitterChapterList"),m=document.getElementById("splitterSelectAllChapters"),h=document.getElementById("splitterDeselectAllChapters");let y=null,x=[];if(!n||!i||!s||!r||!o||!l||!a||!u||!c||!f||!d||!g||!m||!h){console.error("EPUB Splitter UI elements (or tooltip/chapter selection) not found. Initialization failed.");return}f.addEventListener("click",E=>{E.stopPropagation(),f.classList.toggle("active")}),f.addEventListener("keydown",E=>{(E.key==="Enter"||E.key===" ")&&(E.preventDefault(),f.click())}),document.addEventListener("click",E=>{f.classList.contains("active")&&!f.contains(E.target)&&f.classList.remove("active")});function B(){g&&(g.innerHTML=""),d&&(d.style.display="none"),x=[]}function C(E){if(!(!g||!d)){if(g.innerHTML="",E.length===0){d.style.display="none";return}E.forEach((P,w)=>{const k=document.createElement("li"),b=document.createElement("input");b.type="checkbox",b.id=`splitter-chap-${w}`,b.value=w.toString(),b.checked=!0,b.setAttribute("data-chapter-index",w.toString());const I=document.createElement("label");I.htmlFor=b.id,I.textContent=P.title,k.appendChild(b),k.appendChild(I),k.addEventListener("click",$=>{$.target!==b&&(b.checked=!b.checked)}),g.appendChild(k)}),d.style.display="block"}}m.addEventListener("click",()=>{g.querySelectorAll('input[type="checkbox"]').forEach(E=>E.checked=!0)}),h.addEventListener("click",()=>{g.querySelectorAll('input[type="checkbox"]').forEach(E=>E.checked=!1)}),n.addEventListener("change",async E=>{const P=E.target;if(y=P.files?P.files[0]:null,B(),y){r.textContent=`Selected: ${y.name}`,o&&(o.style.display="inline-block"),i.disabled=!0,a&&(a.style.display="none"),u&&(u.style.display="none"),t(!0);try{const w=await ir(y),k=await JSZip.loadAsync(w),b=[],I={},$=[];k.forEach((N,L)=>{I[N]={dir:L.dir,contentType:L.options.contentType},!L.dir&&(N.endsWith(".xhtml")||N.endsWith(".html")||N.includes("content.opf")||N.includes("toc.ncx"))&&$.push(L.async("text").then(S=>I[N].content=S))}),await Promise.all($);const U=new DOMParser;for(let N in I){const L=I[N];if(!L.dir&&L.content){let S=U.parseFromString(L.content,"text/xml");S.querySelector("parsererror")&&(S=U.parseFromString(L.content,"text/html"));const A=S.querySelectorAll('section[epub\\:type="chapter"], div[epub\\:type="chapter"], section.chapter, div.chapter, section[role="chapter"], div[role="chapter"]');if(A.length)A.forEach(z=>{z.querySelectorAll("h1,h2,h3,.title,.chapter-title").forEach(T=>T.remove());const _=z.querySelectorAll("p"),F=_.length?Array.from(_).map(T=>{var j;return((j=T.textContent)==null?void 0:j.trim())||""}).filter(T=>T).join(`
`):(z.textContent||"").replace(/\s*\n\s*/g,`
`).trim();F&&b.push(F)});else{const z=S.querySelectorAll("h1,h2,h3");if(z.length>1)for(let _=0;_<z.length;_++){let F=z[_].nextSibling,T="";for(;F&&!(F.nodeType===1&&/H[1-3]/.test(F.tagName));)T+=F.nodeType===1?F.textContent+`
`:F.textContent,F=F.nextSibling;T=T.replace(/\n{3,}/g,`
`).trim(),T&&b.push(T)}}}}x=b.map((N,L)=>({index:L,title:`Chapter ${L+1} (Preview: ${N.substring(0,50).replace(/\s+/g," ")}${N.length>50?"...":""})`,text:N})),x.length>0?(C(x),i.disabled=!1,e(`Found ${x.length} potential chapters. Review selection.`,!1)):(e("No chapters found for selection. Check EPUB structure.",!0),i.disabled=!0)}catch(w){console.error("EPUB parsing for chapter selection failed:",w),e(`Error parsing EPUB for chapter list: ${w.message}`,!0),i.disabled=!0}finally{t(!1)}}else r.textContent="",o&&(o.style.display="none"),i.disabled=!0}),o.addEventListener("click",()=>{y=null,n.value="",r.textContent="",o.style.display="none",i.disabled=!0,a&&(a.style.display="none"),u&&(u.style.display="none"),B()}),s.addEventListener("change",()=>{l&&(l.style.display=s.value==="grouped"?"block":"none")}),i.addEventListener("click",async()=>{if(!y){e("No file selected for EPUB splitting.",!0);return}if(x.length===0){e("No chapters available for splitting. Please re-upload or check the EPUB.",!0);return}const E=[];if(g.querySelectorAll('input[type="checkbox"]:checked').forEach($=>{const U=parseInt($.value,10);E.push(U)}),E.length===0){e("No chapters selected to split. Please select at least one chapter.",!0);return}const P=x.filter($=>E.includes($.index)).map($=>$.text);q.isNativePlatform()&&Y.impact({style:J.Light}),t(!0),a&&(a.style.display="none"),u&&(u.style.display="none");const w=document.getElementById("chapterPattern"),k=document.getElementById("startNumber"),b=document.getElementById("offsetNumber"),I=document.getElementById("groupSize");try{const $=w.value.trim()||"chapter",U=parseInt(k.value,10)||1,N=Math.max(0,parseInt(b.value,10)||0),L=s.value,S=P.slice(N),A=U,z=new JSZip;if(L==="single")S.forEach((j,O)=>{const Z=String(A+O).padStart(2,"0");z.file(`${$}${Z}.txt`,j)});else{let j=parseInt(I.value,10)||1;for(let O=0;O<S.length;O+=j){const Z=A+O,le=Math.min(A+O+j-1,A+S.length-1),W=Z===le?`${$}${String(Z).padStart(2,"0")}.txt`:`${$}${String(Z).padStart(2,"0")}-${String(le).padStart(2,"0")}.txt`;let K="";for(let ee=0;ee<j&&O+ee<S.length;ee++)ee>0&&(K+=`


---------------- END ----------------


`),K+=S[O+ee];z.file(W,K)}}const{blob:_,count:F,skipped:T}=await z.generateAsync({type:"blob"}).then(j=>({blob:j,count:S.length,skipped:N}));if(c){const j=`${w.value.trim()||"chapter"}_chapters.zip`;await Ne(_,j,"application/zip",e)||(c.href=URL.createObjectURL(_),c.download=j,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(c.href))}u&&(u.style.display="block"),a&&(a.textContent=`Extracted ${F} chapter(s) from your selection.`,a.className="status success",a.style.display="block"),e(`Extracted ${F} chapter(s).`)}catch($){console.error("EPUB Splitter Error:",$),a&&(a.textContent=`Error: ${$.message}`,a.className="status error",a.style.display="block"),e(`Error: ${$.message}`,!0)}finally{t(!1)}})}function ar(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e==="x"?t:t&3|8;return n.toString(16)})}function ht(e){return e?e.replace(/[^a-zA-Z0-9_-]/g,"_"):""}function lr(e,t){let n=`<h2>${oe(t)}</h2>
`;return e.replace(/\r\n/g,`
`).split(/\n\n+/).forEach(o=>{const i=o.trim();i&&(n+=`    <p>${oe(i)}</p>
`)}),`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="en">
<head>
  <title>${oe(t)}</title>
  <link rel="stylesheet" type="text/css" href="../css/style.css" /> 
</head>
<body>
  <section epub:type="chapter">
${n}  </section>
</body>
</html>`}function oe(e){return typeof e!="string"?"":e.replace(/[&<>"']/g,function(t){switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return t}})}function cr(e,t){const n=document.getElementById("zipUploadForEpub"),r=document.getElementById("zipFileNameForEpub"),o=document.getElementById("clearZipUploadForEpub"),i=document.getElementById("epubTitle"),s=document.getElementById("epubAuthor"),l=document.getElementById("epubLanguage"),a=document.getElementById("epubCoverImage"),u=document.getElementById("epubCoverFileName"),c=document.getElementById("clearEpubCoverImage"),p=document.getElementById("createEpubBtn"),f=document.getElementById("statusMessageZipToEpub"),d=document.getElementById("downloadSectionZipToEpub"),g=document.getElementById("downloadLinkEpub");let m=null,h=null;if(!n||!p||!r||!o||!i||!s||!l||!a||!u||!c||!f||!d||!g){console.error("ZIP to EPUB UI elements not found. Initialization failed.");return}n.addEventListener("change",y=>{const x=y.target;m=x.files?x.files[0]:null,m?(r.textContent=`Selected ZIP: ${m.name}`,o&&(o.style.display="inline-block"),p.disabled=!1,f&&(f.style.display="none"),d&&(d.style.display="none")):(r.textContent="",o&&(o.style.display="none"),p.disabled=!0)}),o.addEventListener("click",()=>{m=null,n.value="",r.textContent="",o.style.display="none",p.disabled=!0,f&&(f.style.display="none"),d&&(d.style.display="none")}),a.addEventListener("change",y=>{const x=y.target;h=x.files?x.files[0]:null,h?(u.textContent=`Cover: ${h.name}`,c&&(c.style.display="inline-block")):(u.textContent="",c&&(c.style.display="none"))}),c.addEventListener("click",()=>{h=null,a.value="",u.textContent="",c.style.display="none"}),p.addEventListener("click",async()=>{var E,P;if(!m){e("Please upload a ZIP file containing chapter .txt files.",!0);return}q.isNativePlatform()&&Y.impact({style:J.Light});const y=i.value.trim()||"Untitled EPUB",x=s.value.trim()||"Unknown Author",B=l.value.trim()||"en",C=`urn:uuid:${ar()}`;t(!0),f&&(f.style.display="none"),d&&(d.style.display="none");try{const w=new JSZip;w.file("mimetype","application/epub+zip",{compression:"STORE"}),(E=w.folder("META-INF"))==null||E.file("container.xml",`<?xml version="1.0" encoding="UTF-8"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`);const b=w.folder("OEBPS");if(!b)throw new Error("Could not create OEBPS folder.");const I=b.folder("css");if(!I)throw new Error("Could not create OEBPS/css folder.");const $=b.folder("text");if(!$)throw new Error("Could not create OEBPS/text folder.");const U=b.folder("images");if(!U)throw new Error("Could not create OEBPS/images folder.");I.file("style.css",`body { font-family: sans-serif; line-height: 1.5; margin: 1em; }
h1, h2, h3 { text-align: center; }
p { text-indent: 1.5em; margin-top: 0; margin-bottom: 0.5em; }
.cover { text-align: center; margin-top: 20%; }
.cover img { max-width: 80%; max-height: 80vh; }`);const L=await JSZip.loadAsync(m),S=[];L.forEach((M,H)=>{!H.dir&&H.name.toLowerCase().endsWith(".txt")&&S.push(H.async("string").then(be=>({name:H.name,originalName:M,content:be})))});let A=await Promise.all(S);if(A.length===0)throw new Error("No .txt files found in the uploaded ZIP.");A.sort((M,H)=>M.name.localeCompare(H.name,void 0,{numeric:!0,sensitivity:"base"}));const z=[{id:"css",href:"css/style.css","media-type":"text/css"},{id:"nav",href:"nav.xhtml","media-type":"application/xhtml+xml",properties:"nav"}],_=[],F=[],T=[];let j=1,O=null,Z=!1;if(h){const M=((P=h.name.split(".").pop())==null?void 0:P.toLowerCase())||"png";O=`cover.${M}`;const H=M==="jpg"||M==="jpeg"?"image/jpeg":"image/png",be=await h.arrayBuffer();U.file(O,be),z.push({id:"cover-image",href:`images/${O}`,"media-type":H,properties:"cover-image"});const de=`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="${B}">
<head>
  <title>Cover</title>
  <link rel="stylesheet" type="text/css" href="../css/style.css" />
</head>
<body>
  <section epub:type="cover" class="cover">
    <img src="../images/${O}" alt="Cover Image"/>
  </section>
</body>
</html>`;$.file("cover.xhtml",de),z.push({id:"cover-page",href:"text/cover.xhtml","media-type":"application/xhtml+xml"}),_.push({idref:"cover-page",linear:"no"}),Z=!0}for(let M=0;M<A.length;M++){const H=A[M],de=`${ht(H.name.replace(/\.txt$/i,""))||`chapter_${M+1}`}.xhtml`,Te=H.name.replace(/\.txt$/i,"").replace(/_/g," "),Ot=lr(H.content,Te);$.file(de,Ot);const nt=`chapter-${M+1}`;z.push({id:nt,href:`text/${de}`,"media-type":"application/xhtml+xml"}),_.push({idref:nt,linear:"yes"}),F.push(`<li><a href="text/${de}">${oe(Te)}</a></li>`),T.push(`
    <navPoint id="navpoint-${j}" playOrder="${j}">
      <navLabel><text>${oe(Te)}</text></navLabel>
      <content src="text/${de}"/>
    </navPoint>`),j++}const le=`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="${B}">
<head>
  <title>Table of Contents</title>
  <link rel="stylesheet" type="text/css" href="css/style.css"/>
</head>
<body>
  <nav epub:type="toc" id="toc">
    <h1>Table of Contents</h1>
    <ol>
      ${F.join(`
      `)}
    </ol>
  </nav>
  <nav epub:type="landmarks" hidden="hidden">
    <ol>
      ${Z?'<li><a epub:type="cover" href="text/cover.xhtml">Cover</a></li>':""}
      <li><a epub:type="toc" href="nav.xhtml">Table of Contents</a></li>
      <li><a epub:type="bodymatter" href="text/${ht(A[0].name.replace(/\.txt$/i,""))||"chapter_1"}.xhtml">Start Reading</a></li>
    </ol>
  </nav>
</body>
</html>`;b.file("nav.xhtml",le);const W=`<?xml version="1.0" encoding="UTF-8"?>
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
  <head>
    <meta name="dtb:uid" content="${C}"/>
    <meta name="dtb:depth" content="1"/>
    <meta name="dtb:totalPageCount" content="0"/>
    <meta name="dtb:maxPageNumber" content="0"/>
  </head>
  <docTitle><text>${oe(y)}</text></docTitle>
  <navMap>
    ${T.join(`
    `)}
  </navMap>
</ncx>`;b.file("toc.ncx",W),z.push({id:"ncx",href:"toc.ncx","media-type":"application/x-dtbncx+xml"});let K=z.map(M=>{let H=M.properties?` properties="${M.properties}"`:"";return`<item id="${M.id}" href="${M.href}" media-type="${M["media-type"]}"${H}/>`}).join(`
    `),ee=_.map(M=>{let H=M.linear?` linear="${M.linear}"`:"";return`<itemref idref="${M.idref}"${H}/>`}).join(`
    `);const Q=`<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookId" version="3.0">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf">
    <dc:identifier id="BookId">${C}</dc:identifier>
    <dc:title>${oe(y)}</dc:title>
    <dc:language>${B}</dc:language>
    <dc:creator id="creator">${oe(x)}</dc:creator>
    <meta property="dcterms:modified">${new Date().toISOString().replace(/\.\d+Z$/,"Z")}</meta>
    ${h?'<meta name="cover" content="cover-image"/>':""}
  </metadata>
  <manifest>
    ${K}
  </manifest>
  <spine toc="ncx">
    ${ee}
  </spine>
</package>`;b.file("content.opf",Q);const tt=await w.generateAsync({type:"blob",mimeType:"application/epub+zip",compression:"DEFLATE"});if(g){const H=`${y.replace(/[^a-z0-9_\-\s]/gi,"_").replace(/\s+/g,"_")||"generated_epub"}.epub`;await Ne(tt,H,"application/epub+zip",e)||(g.href=URL.createObjectURL(tt),g.download=H,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(g.href))}d&&(d.style.display="block"),f&&(f.textContent=`EPUB "${y}" created successfully with ${A.length} chapter(s).`,f.className="status success",f.style.display="block"),e("EPUB created successfully!")}catch(w){console.error("ZIP to EPUB Error:",w),f&&(f.textContent=`Error: ${w.message}`,f.className="status error",f.style.display="block"),e(`Error: ${w.message}`,!0)}finally{t(!1)}})}let Ee=null,he=[],fe="",Ue="";const Qe=new DOMParser;function ur(e){return new Promise((t,n)=>{const r=new FileReader;r.onload=o=>{var i;return t((i=o.target)==null?void 0:i.result)},r.onerror=o=>n(new Error(`FileReader error: ${o}`)),r.readAsArrayBuffer(e)})}async function qe(e,t){const n=t.startsWith("/")?t.substring(1):t,r=e.file(n);if(!r)return console.error(`File not found in EPUB archive: ${n}`),null;try{const o=await r.async("string");return{path:n,content:o}}catch(o){return console.error(`Error reading file "${n}" from zip:`,o),null}}function He(e,t="XML"){try{const n=Qe.parseFromString(e,"application/xml"),r=n.querySelector("parsererror");return r?(console.error(`XML Parsing Error in ${t}:`,r.textContent),null):n}catch(n){return console.error(`Exception during XML parsing of ${t}:`,n),null}}function dr(e,t="HTML"){try{const n=Qe.parseFromString(e,"text/html");return(!n||!n.body&&!n.documentElement)&&console.warn(`Parsed HTML for ${t} seems empty or invalid.`),n}catch(n){return console.error(`Exception during HTML parsing of ${t}:`,n),null}}function fr(e){var t,n;try{const r=" P ",o=" L ";let i=e;i=i.replace(/<\/(p|h[1-6]|div|li|blockquote|pre|section|article|aside|header|footer|nav|figure|figcaption|table|tr|th|td)>\s*/gi,"$&"+r),i=i.replace(/<br\s*\/?>/gi,o);const s=Qe.parseFromString(i,"text/html"),l=s.body;if(!l)return console.warn("HTML string appears to lack a <body> tag, attempting fallback."),(((t=s.documentElement)==null?void 0:t.innerText)||((n=s.documentElement)==null?void 0:n.textContent)||"").trim();l.querySelectorAll("script, style").forEach(u=>u.remove());let a=l.textContent||"";return a=a.replace(new RegExp(r.trim().replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),`

`),a=a.replace(new RegExp(o.trim().replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),`
`),a=a.replace(/[ \t]+/g," "),a=a.replace(/ *\n */g,`
`),a=a.replace(/\n{3,}/g,`

`),a.trim()}catch(r){return console.error("Error extracting text from HTML:",r),""}}function et(e,t){if(!e)return"";if(!t)return e.startsWith("/")?e.substring(1):e;try{const n=`file:///${t}/`;let o=new URL(e,n).pathname.substring(1);return decodeURIComponent(o)}catch(n){console.error(`Error resolving path: relative="${e}", base="${t}"`,n);const r=(t+"/"+e).replace(/\/+/g,"/");return console.warn(`Falling back to simple path concatenation: ${r}`),r}}function mt(e){if(!e)return"download";let t=e.replace(/[^\p{L}\p{N}._-]+/gu,"_");return t=t.replace(/__+/g,"_"),t=t.replace(/^[_.-]+|[_.-]+$/g,""),t=t.substring(0,100),t||"file"}async function pr(e,t,n,r){if(!await Ne(e,t,n,r)){const i=document.createElement("a"),s=URL.createObjectURL(e);i.href=s,i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}}function hr(e){return new Promise(t=>setTimeout(t,e))}async function mr(e){const t="META-INF/container.xml",n=await qe(e,t);if(!n)return null;const r=He(n.content,t);if(!r)return null;const o=r.querySelector("rootfile[full-path]"),i=o==null?void 0:o.getAttribute("full-path");if(!i)return console.error("Cannot find rootfile[full-path] attribute in container.xml"),null;const s=i.includes("/")?i.substring(0,i.lastIndexOf("/")):"";return{path:i,dir:s}}function gr(e){const t=e.querySelector('manifest > item[properties~="nav"]');if(t){const r=t.getAttribute("href");if(r)return console.log("Found EPUB3 NAV ToC reference:",r),{href:r,type:"nav"}}const n=e.querySelector("spine[toc]");if(n){const r=n.getAttribute("toc");if(r){const o=e.querySelector(`manifest > item[id="${r}"]`);if(o){const i=o.getAttribute("href");if(i)return console.log("Found EPUB2 NCX ToC reference:",i),{href:i,type:"ncx"}}}}return null}function yr(e,t){const n=[];let r=0;return e.querySelectorAll("navMap navPoint").forEach(i=>{var a,u,c;const s=(u=(a=i.querySelector("navLabel > text"))==null?void 0:a.textContent)==null?void 0:u.trim(),l=(c=i.querySelector("content"))==null?void 0:c.getAttribute("src");if(s&&l){const p=et(l.split("#")[0],t);n.push({title:s,href:p,id:`epubzip-chap-${r}`,originalIndex:r++})}}),n}function vr(e,t){const n=[];let r=0,o=e.querySelector('nav[epub\\:type="toc"] ol, nav#toc ol, nav.toc ol');return!o&&e.body&&(o=e.body.querySelector("ol"),o&&console.warn("Using generic 'ol' fallback for NAV ToC list.")),o?o.querySelectorAll(":scope > li > a[href]").forEach(s=>{const l=(s.textContent||"").replace(/\s+/g," ").trim(),a=s.getAttribute("href");if(l&&a){const u=et(a.split("#")[0],t);n.push({title:l,href:u,id:`epubzip-chap-${r}`,originalIndex:r++})}}):console.warn("Could not find a suitable <ol> list within the NAV document for the Table of Contents."),n}function br(e){const t=[],n=new Set;for(const r of e)r.href&&!n.has(r.href)?(t.push(r),n.add(r.href)):n.has(r.href)?console.log(`Duplicate chapter href found and removed: ${r.href} (Title: ${r.title})`):console.warn(`Chapter entry skipped due to missing href: (Title: ${r.title})`);return t}async function xr(e,t){fe="",he=[];const n=await mr(e);if(!n)return t("Error: Could not find EPUB's OPF file.",!0),[];fe=n.dir;const r=await qe(e,n.path);if(!r)return t(`Error: Could not read OPF file at ${n.path}`,!0),[];const o=He(r.content,r.path);if(!o)return t(`Error: Could not parse OPF XML at ${n.path}`,!0),[];const i=gr(o);if(!i)return t("Warning: No standard Table of Contents (NAV/NCX) link found in OPF.",!0),[];const s=et(i.href,fe),l=await qe(e,s);if(!l)return t(`Error: ToC file not found at ${s}`,!0),[];let a;if(i.type==="ncx"){const u=He(l.content,l.path);a=u?yr(u,fe):[],u||t(`Error: Could not parse NCX file XML at ${l.path}`,!0)}else{const u=dr(l.content,l.path);a=u?vr(u,fe):[],u||t(`Error: Could not parse NAV file HTML at ${l.path}`,!0)}return he=br(a),he}function Er(e,t){const n=document.getElementById("epubUploadForTxt"),r=document.getElementById("epubFileNameForTxt"),o=document.getElementById("clearEpubUploadForTxt"),i=document.getElementById("extractChaptersBtn"),s=document.getElementById("statusMessageEpubToZip"),l=document.getElementById("downloadSectionEpubToZip"),a=document.getElementById("downloadLinkZipFromEpub"),u=document.getElementById("epubToZipEnableRemoveLines"),c=document.getElementById("epubToZipRemoveLinesOptionsGroup"),p=document.getElementById("epubToZipLinesToRemove"),f=document.getElementById("epubToZipChapterSelectionArea"),d=document.getElementById("epubToZipChapterList"),g=document.getElementById("epubToZipSelectAllChapters"),m=document.getElementById("epubToZipDeselectAllChapters");if(!n||!i||!u||!c||!p||!r||!o||!s||!l||!a||!f||!d||!g||!m){console.error("EPUB to ZIP UI elements not found.");return}u.addEventListener("change",C=>{const E=C.target;c&&(c.style.display=E.checked?"block":"none")});function h(C,E=!1){s&&(s.textContent=C,s.style.display="block",s.className=E?"status error":"status success"),E?e(C,!0):(C.toLowerCase().includes("download started")||C.toLowerCase().includes("file saved"))&&e(C,!1)}function y(){d&&(d.innerHTML=""),f&&(f.style.display="none")}function x(C){if(!(!d||!f)){if(d.innerHTML="",C.length===0){f.style.display="none";return}C.forEach(E=>{const P=document.createElement("li"),w=document.createElement("input");w.type="checkbox",w.id=E.id||`epubzip-chap-${E.originalIndex}`,w.value=E.originalIndex!==void 0?E.originalIndex.toString():E.href,w.checked=!0,w.setAttribute("data-chapter-href",E.href);const k=document.createElement("label");k.htmlFor=w.id,k.textContent=E.title,P.appendChild(w),P.appendChild(k),d.appendChild(P)}),f.style.display="block"}}g.addEventListener("click",()=>{d.querySelectorAll('input[type="checkbox"]').forEach(C=>C.checked=!0)}),m.addEventListener("click",()=>{d.querySelectorAll('input[type="checkbox"]').forEach(C=>C.checked=!1)});function B(C=!0){h("Select an EPUB file."),l&&(l.style.display="none"),i.disabled=!0,Ee=null,he=[],fe="",Ue="",y(),C&&(n.value="",r.textContent="",o&&(o.style.display="none")),u&&(u.checked=!1),c&&(c.style.display="none"),p&&(p.value="1")}o.addEventListener("click",()=>{B(!0)}),n.addEventListener("change",async C=>{var w,k;const E=C.target,P=E.files?E.files[0]:null;if(B(!1),!P){r.textContent="",o&&(o.style.display="none");return}if(!P.name.toLowerCase().endsWith(".epub")){h("Error: Please select a valid .epub file.",!0),n.value="",r.textContent="",o&&(o.style.display="none");return}Ue=P.name,r.textContent=`Selected: ${P.name}`,o&&(o.style.display="inline-block"),h(`Reading ${P.name}...`),t(!0);try{const b=await ur(P);h("Unzipping EPUB..."),Ee=await JSZip.loadAsync(b),h("Parsing Table of Contents...");const I=await xr(Ee,h);I.length>0?(x(I),h(`Found ${I.length} chapters. Review selection and options.`),i.disabled=!1):(!((w=s==null?void 0:s.textContent)!=null&&w.toLowerCase().includes("error"))&&!((k=s==null?void 0:s.textContent)!=null&&k.toLowerCase().includes("warning"))&&h("No chapters found or ToC unparsable. Some EPUBs might lack a standard ToC.",!0),i.disabled=!0)}catch(b){console.error("EPUB selection/parsing Error:",b),h(`Error: ${b.message||"Could not process EPUB."}`,!0),B(!0)}finally{t(!1)}}),i.addEventListener("click",async()=>{if(!Ee||he.length===0){h("Cannot extract: No EPUB loaded or no chapters found.",!0);return}const C=[];if(d.querySelectorAll('input[type="checkbox"]:checked').forEach(b=>{const $=b.getAttribute("data-chapter-href"),U=he.find(N=>N.href===$);U&&C.push(U)}),C.length===0){h("No chapters selected to extract. Please select at least one chapter.",!0);return}q.isNativePlatform()&&Y.impact({style:J.Light}),i.disabled=!0,i.textContent="Extracting...",t(!0);const E=new JSZip;let P=0;const w=C.length;let k=0;u.checked&&(k=parseInt(p.value,10),(isNaN(k)||k<0)&&(k=0));try{h(`Starting chapter extraction (0/${w})...`);for(let b=0;b<w;b++){const I=C[b];h(`Processing chapter ${b+1}/${w}: ${I.title.substring(0,30)}...`);const $=Ee.file(I.href);if(!$){console.warn(`Chapter file not found in EPUB: ${I.href}`);continue}const U=await $.async("uint8array");let N;try{N=new TextDecoder("utf-8",{fatal:!1}).decode(U)}catch(S){console.error(`Error decoding chapter ${I.href} as UTF-8:`,S),N="",h(`Warning: Could not decode chapter "${I.title.substring(0,30)}". It may be corrupted or not UTF-8.`,!0)}let L=fr(N);if(k>0&&L){const S=L.split(`
`);S.length>k?L=S.slice(k).join(`
`):L=""}if(L&&L.trim().length>0){const A=`${mt(I.title)||`Chapter_${String(b+1).padStart(2,"0")}`}.txt`;E.file(A,L),P++}else console.warn(`No text content extracted (or became empty after line removal) from: ${I.href}`);await hr(5)}if(P>0){h(`Generating ZIP file with ${P} chapters...`);const b=await E.generateAsync({type:"blob",compression:"DEFLATE"}),I=Ue.replace(/\.epub$/i,"")||"epub_content",$=`${mt(I)}_chapters.zip`;await pr(b,$,"application/zip",h),h(`Download started / File saved (${P}/${w} chapters).`),l&&a&&(a.href="#",a.download=$,l.style.display="block")}else h("Extraction complete, but no chapter content was retrieved or all content was removed by line filter. Ensure EPUB content is as expected and check 'lines to remove' setting.",!0)}catch(b){console.error("Error during chapter extraction or ZIP creation:",b),h(`Error: ${b.message}`,!0)}finally{i.disabled=!1,i.textContent="Extract Chapters to ZIP",t(!1)}})}function wr(e,t){const n=document.getElementById("zipBackupFile"),r=document.getElementById("zipBackupFileName"),o=document.getElementById("clearZipBackupFile"),i=document.getElementById("zipProjectTitle"),s=document.getElementById("zipDescription"),l=document.getElementById("zipUniqueCode"),a=document.getElementById("zipChapterPattern"),u=document.getElementById("zipStartNumber"),c=document.getElementById("zipExtraChapters"),p=document.getElementById("createFromZipBtn"),f=document.getElementById("statusMessageCreateBackupFromZip"),d=document.querySelector("#createBackupFromZipApp .tooltip-trigger");if(!n||!r||!o||!i||!s||!l||!a||!u||!c||!p||!f||!d){console.error("Create Backup from ZIP: One or more UI elements not found. Initialization failed.");return}d.addEventListener("click",g=>{g.stopPropagation(),d.classList.toggle("active")}),document.addEventListener("click",g=>{d.classList.contains("active")&&!d.contains(g.target)&&d.classList.remove("active")}),p.disabled=!0,n.addEventListener("change",()=>{p.disabled=!(n.files&&n.files.length>0),f&&(f.style.display="none"),n.files&&n.files.length>0?(r.textContent=`Selected: ${n.files[0].name}`,o&&(o.style.display="inline-block")):(r.textContent="",o&&(o.style.display="none"))}),o.addEventListener("click",()=>{n.value="",r.textContent="",o.style.display="none",p.disabled=!0,f&&(f.style.display="none")}),p.addEventListener("click",async()=>{if(q.isNativePlatform()&&Y.impact({style:J.Light}),f&&(f.style.display="none"),t(!0),!n.files||n.files.length===0){e("Please upload a ZIP file.",!0),f&&(f.textContent="Error: Please upload a ZIP file.",f.className="status error",f.style.display="block"),t(!1);return}const g=i.value;if(!g){e("Project Title is required.",!0),f&&(f.textContent="Error: Project Title is required.",f.className="status error",f.style.display="block"),t(!1);return}const m=n.files[0],h=s.value,y=l.value.trim(),x=a.value.trim(),B=parseInt(u.value,10)||1,C=parseInt(c.value,10)||0;try{const E=await JSZip.loadAsync(m),P=[],w=[];let k=0;const b=[];E.forEach((_,F)=>{!F.dir&&F.name.toLowerCase().endsWith(".txt")&&b.push(F.async("string").then(T=>({name:F.name,text:T})))});const I=await Promise.all(b);I.sort((_,F)=>_.name.localeCompare(F.name,void 0,{numeric:!0,sensitivity:"base"}));for(const _ of I){const F=B+k,T=`scene${F}`,j=`section${F}`;let O;x?O=`${x}${F}`:O=_.name.replace(/\.txt$/i,"");const Z=_.text,W=Z.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(/\n{2,}/).map(Q=>Q.trim()).filter(Q=>Q!==""),K=[];for(let Q=0;Q<W.length;Q++)K.push({type:"text",align:"left",text:W[Q]}),(Q<W.length-1||W.length===0)&&K.push({type:"text",align:"left"});W.length===0&&(Z.trim()===""&&Z.length>0?K.push({type:"text",align:"left"}):Z.trim()===""&&K.push({type:"text",align:"left",text:""})),K.length===0&&K.push({type:"text",align:"left",text:""});const ee=JSON.stringify({blocks:K});P.push({code:T,title:O,text:ee,ranking:F,status:"1"}),w.push({code:j,title:O,synopsis:"",ranking:F,section_scenes:[{code:T,ranking:1}]}),k++}if(C>0)for(let _=0;_<C;_++){const F=B+k,T=`scene${F}`,j=`section${F}`;let O;x?O=`${x}${F}`:O=`Extra Chapter ${F}`;const Z={blocks:[{type:"text",align:"left",text:""}]};P.push({code:T,title:O,text:JSON.stringify(Z),ranking:F,status:"1"}),w.push({code:j,title:O,synopsis:"",ranking:F,section_scenes:[{code:T,ranking:1}]}),k++}if(P.length===0)throw new Error("No .txt files found in ZIP and no extra chapters requested. Backup not created.");const $=y||Math.floor(Math.random()*4294967295).toString(16).padStart(8,"0"),U=Date.now();let N=0;P.forEach(_=>{try{JSON.parse(_.text).blocks.forEach(T=>{T.type==="text"&&typeof T.text=="string"&&T.text.trim()&&(N+=T.text.trim().split(/\s+/).length)})}catch(F){console.warn("Word count parse error:",F)}});const L={version:4,code:$,title:g,description:h,show_table_of_contents:!0,apply_automatic_indentation:!1,last_update_date:U,last_backup_date:U,revisions:[{number:1,date:U,book_progresses:[{year:new Date().getFullYear(),month:new Date().getMonth()+1,day:new Date().getDate(),word_count:N}],statuses:[{code:"1",title:"Todo",color:-2697255,ranking:1}],scenes:P,sections:w}]},S=new Blob([JSON.stringify(L,null,2)],{type:"application/json"}),z=`${g.replace(/[^a-z0-9_\-\s]/gi,"_").replace(/\s+/g,"_")||"backup_from_zip"}.json`;await ve(S,z,"application/json",e),f&&(f.textContent=`Backup file created with ${P.length} chapter(s). Download started.`,f.className="status success",f.style.display="block"),e(`Backup file created with ${P.length} chapter(s).`)}catch(E){console.error("Create Backup from ZIP Error:",E),f&&(f.textContent=`Error: ${E.message}`,f.className="status error",f.style.display="block"),e(`Error: ${E.message}`,!0)}finally{t(!1)}})}function kr(e,t){const n=document.getElementById("createNewBackupBtn"),r=document.getElementById("statusCreateNewBackup");if(!n){console.error("Create New Backup: 'Generate and Download' button not found. Initialization failed.");return}n.addEventListener("click",async()=>{q.isNativePlatform()&&Y.impact({style:J.Light}),r&&(r.style.display="none"),t(!0);try{const o=document.getElementById("createProjectTitle"),i=document.getElementById("createDescription"),s=document.getElementById("createUniqueCode"),l=document.getElementById("createChapters"),a=document.getElementById("createPrefix");if(!o||!i||!s||!l||!a)throw e("One or more form elements are missing for Create New Backup.",!0),new Error("Missing form elements.");const u=o.value,c=i.value,p=s.value.trim(),f=parseInt(l.value,10)||0,d=a.value,g=!0,m=!1;if(!u||f<1)throw e("Project Title and at least 1 chapter are required.",!0),r&&(r.textContent="Error: Project Title and at least 1 chapter are required.",r.className="status error",r.style.display="block"),new Error("Validation failed for create new backup.");const h=p||Math.floor(Math.random()*4294967295).toString(16).padStart(8,"0"),y=Date.now(),x=[],B=[];for(let w=1;w<=f;w++){const k=d?d+w:w.toString(),b="scene"+w,I={blocks:[{type:"text",align:"left",text:""}]};x.push({code:b,title:k,text:JSON.stringify(I),ranking:w,status:"1"}),B.push({code:"section"+w,title:k,synopsis:"",ranking:w,section_scenes:[{code:b,ranking:1}]})}const C={version:4,code:h,title:u,description:c,show_table_of_contents:g,apply_automatic_indentation:m,last_update_date:y,last_backup_date:y,revisions:[{number:1,date:y,book_progresses:[{year:new Date().getFullYear(),month:new Date().getMonth()+1,day:new Date().getDate(),word_count:0}],statuses:[{code:"1",title:"Todo",color:-2697255,ranking:1}],scenes:x,sections:B}]},E=new Blob([JSON.stringify(C,null,2)],{type:"application/json"}),P=`${u.replace(/[^a-z0-9_\-\s]/gi,"_").replace(/\s+/g,"_")||"new_backup"}.json`;await ve(E,P,"application/json",e),r&&(r.textContent="Backup file created successfully. Download started.",r.className="status success",r.style.display="block"),e("Backup file created successfully.")}catch(o){o.message!=="Validation failed for create new backup."&&o.message!=="Missing form elements."&&(e(o.message||"Error creating backup.",!0),r&&(r.textContent=`Error: ${o.message||"Could not create backup."}`,r.className="status error",r.style.display="block")),console.error("Create New Backup Error:",o)}finally{t(!1)}})}function Ir(e,t){const n=document.getElementById("extendBackupBtn"),r=document.getElementById("extendBackupFile"),o=document.getElementById("extendBackupFileName"),i=document.getElementById("clearExtendBackupFile"),s=document.getElementById("extendExtraChapters"),l=document.getElementById("extendPrefix"),a=document.getElementById("statusExtendBackup");if(!n||!r||!o||!i||!s||!l){console.error("Extend Backup: One or more UI elements not found. Initialization failed.");return}r.addEventListener("change",()=>{r.files&&r.files.length>0?(o.textContent=`Selected: ${r.files[0].name}`,i&&(i.style.display="inline-block")):(o.textContent="",i&&(i.style.display="none")),a&&(a.style.display="none")}),i.addEventListener("click",()=>{r.value="",o.textContent="",i.style.display="none",a&&(a.style.display="none")}),n.addEventListener("click",()=>{if(q.isNativePlatform()&&Y.impact({style:J.Light}),!r.files||!r.files.length){e("Please upload a backup file to extend.",!0),a&&(a.textContent="Error: Please upload a backup file.",a.className="status error",a.style.display="block");return}a&&(a.style.display="none"),t(!0);const u=parseInt(s.value,10)||0;if(u<=0){e("Number of extra chapters must be greater than 0.",!0),a&&(a.textContent="Error: Number of extra chapters must be greater than 0.",a.className="status error",a.style.display="block"),t(!1);return}const c=l.value,p=new FileReader;p.onerror=()=>{e("Error reading file.",!0),a&&(a.textContent="Error: Could not read the uploaded file.",a.className="status error",a.style.display="block"),t(!1)},p.onload=async f=>{var d;try{const g=JSON.parse((d=f.target)==null?void 0:d.result),m=g.revisions&&g.revisions[0];if(!m||!m.scenes||!m.sections)throw new Error("Invalid backup file structure for extending.");let h=0;m.scenes.forEach(C=>{C.ranking>h&&(h=C.ranking)}),m.sections.forEach(C=>{C.ranking>h&&(h=C.ranking)});for(let C=1;C<=u;C++){const E=h+C,P=c?c+E:`Chapter ${E}`,w="scene"+E,k={blocks:[{type:"text",align:"left",text:""}]};m.scenes.push({code:w,title:P,text:JSON.stringify(k),ranking:E,status:"1"}),m.sections.push({code:"section"+E,title:P,synopsis:"",ranking:E,section_scenes:[{code:w,ranking:1}]})}const y=Date.now();g.last_update_date=y,g.last_backup_date=y,m&&(m.date=y);const x=new Blob([JSON.stringify(g,null,2)],{type:"application/json"}),B=`${g.title.replace(/[^a-z0-9_\-\s]/gi,"_").replace(/\s+/g,"_")||"extended_backup"}.json`;await ve(x,B,"application/json",e),a&&(a.textContent=`Backup extended with ${u} chapter(s). Download started.`,a.className="status success",a.style.display="block"),e("Backup extended successfully.")}catch(g){e(g.message||"Error extending backup.",!0),a&&(a.textContent=`Error: ${g.message||"Could not extend backup."}`,a.className="status error",a.style.display="block"),console.error("Extend Backup Error:",g)}finally{t(!1)}},p.readAsText(r.files[0])})}async function Cr(e,t,n,r,o,i){let s=[],l=[];const a=[],u=new Set;for(const d of e)try{const g=await d.text(),m=JSON.parse(g),h=m.revisions&&m.revisions[0];h&&(h.scenes&&(o&&h.scenes.forEach(y=>y.originalTitle=y.title),s=s.concat(h.scenes)),h.sections&&(o&&h.sections.forEach(y=>y.originalTitle=y.title),l=l.concat(h.sections)),h.statuses&&h.statuses.length>0&&h.statuses.forEach(y=>{u.has(y.code)||(a.push(y),u.add(y.code))}))}catch(g){console.warn(`Skipping file ${d.name} in merge due to parse error:`,g),i(`Skipped ${d.name} during merge (invalid format).`,!0)}const c=a.sort((d,g)=>(d.ranking||1/0)-(g.ranking||1/0)).map((d,g)=>({...d,ranking:g+1}));c.length===0&&c.push({code:"1",title:"Todo",color:-2697255,ranking:1}),s.forEach((d,g)=>{const m=g+1;d.code="scene"+m,o&&d.originalTitle?d.title=r?`${r}${d.originalTitle}`:d.originalTitle:d.title=r?`${r}${m}`:`Chapter ${m}`,d.ranking=m,delete d.originalTitle}),l.forEach((d,g)=>{const m=g+1;d.code="section"+m,o&&d.originalTitle?d.title=r?`${r}${d.originalTitle}`:d.originalTitle:d.title=r?`${r}${m}`:`Chapter ${m}`,d.ranking=m,delete d.originalTitle,d.section_scenes=[{code:"scene"+m,ranking:1}]});const p=Date.now();let f=0;return s.forEach(d=>{try{JSON.parse(d.text).blocks.forEach(m=>{m.type==="text"&&typeof m.text=="string"&&m.text.trim()&&(f+=m.text.trim().split(/\s+/).length)})}catch(g){console.warn("Word count error in merged scene:",g)}}),{version:4,code:Math.floor(Math.random()*4294967295).toString(16).padStart(8,"0"),title:t,description:n,show_table_of_contents:!0,apply_automatic_indentation:!1,last_update_date:p,last_backup_date:p,revisions:[{number:1,date:p,book_progresses:[{year:new Date().getFullYear(),month:new Date().getMonth()+1,day:new Date().getDate(),word_count:f}],statuses:c,scenes:s,sections:l}]}}function Br(e,t){const n=document.getElementById("mergeBackupBtn"),r=document.getElementById("mergeBackupFiles"),o=document.getElementById("mergeBackupFileNames"),i=document.getElementById("clearMergeBackupFiles"),s=document.getElementById("mergeProjectTitle"),l=document.getElementById("mergeDescription"),a=document.getElementById("mergePrefix"),u=document.getElementById("mergePreserveTitles"),c=document.getElementById("statusMergeBackup");if(!n||!r||!o||!i||!s||!l||!a||!u){console.error("Merge Backup: One or more UI elements not found. Initialization failed.");return}r.addEventListener("change",()=>{if(r.files&&r.files.length>0){let p='<ul style="margin: 0; padding-left: 15px; font-size: 0.9em;">';for(let f=0;f<r.files.length;f++)p+=`<li>${r.files[f].name}</li>`;p+="</ul>",o.innerHTML=p,i&&(i.style.display="inline-block")}else o.textContent="No files selected.",i&&(i.style.display="none");c&&(c.style.display="none")}),i.addEventListener("click",()=>{r.value="",o.textContent="No files selected.",i.style.display="none",c&&(c.style.display="none")}),n.addEventListener("click",async()=>{q.isNativePlatform()&&Y.impact({style:J.Light});const p=r.files?Array.from(r.files):[],f=s.value,d=l.value,g=a.value,m=u.checked;if(!p.length){e("Select at least one backup file to merge.",!0),c&&(c.textContent="Error: Select at least one backup file.",c.className="status error",c.style.display="block");return}if(!f){e("Merged Project Title is required.",!0),c&&(c.textContent="Error: Merged Project Title is required.",c.className="status error",c.style.display="block");return}c&&(c.style.display="none"),t(!0);try{const h=await Cr(p,f,d,g,m,e);if(h.revisions[0].scenes.length===0)throw e("No valid chapters found in the selected files to merge.",!0),c&&(c.textContent="Error: No valid chapters to merge.",c.className="status error",c.style.display="block"),new Error("Merge resulted in no scenes.");const y=new Blob([JSON.stringify(h,null,2)],{type:"application/json"}),x=`${f.replace(/[^a-z0-9_\-\s]/gi,"_").replace(/\s+/g,"_")||"merged_backup"}.json`;await ve(y,x,"application/json",e),c&&(c.textContent=`Backup files merged into "${f}". Download started.`,c.className="status success",c.style.display="block"),e("Backup files merged successfully.")}catch(h){h.message!=="Merge resulted in no scenes."&&(e(h.message||"Error merging backup files.",!0),c&&(c.textContent=`Error: ${h.message||"Could not merge backups."}`,c.className="status error",c.style.display="block")),console.error("Merge Backup Error:",h)}finally{t(!1)}})}function Sr(e,t){const n=document.getElementById("augmentBaseBackupFile"),r=document.getElementById("augmentBaseBackupFileName"),o=document.getElementById("clearAugmentBaseBackupFile"),i=document.getElementById("augmentZipFile"),s=document.getElementById("augmentZipFileName"),l=document.getElementById("clearAugmentZipFile"),a=document.getElementById("augmentPrefix"),u=document.getElementById("augmentPreserveTxtTitles"),c=document.getElementById("augmentBackupBtn"),p=document.getElementById("statusAugmentBackup");let f=null,d=null;if(!n||!r||!o||!i||!s||!l||!a||!u||!c||!p){console.error("Augment Backup with ZIP: One or more UI elements not found. Initialization failed.");return}function g(){c.disabled=!(f&&d)}n.addEventListener("change",m=>{var h;f=((h=m.target.files)==null?void 0:h[0])||null,f?(r.textContent=`Selected: ${f.name}`,o.style.display="inline-block"):(r.textContent="",o.style.display="none"),p&&(p.style.display="none"),g()}),o.addEventListener("click",()=>{n.value="",f=null,r.textContent="",o.style.display="none",p&&(p.style.display="none"),g()}),i.addEventListener("change",m=>{var h;d=((h=m.target.files)==null?void 0:h[0])||null,d?(s.textContent=`Selected: ${d.name}`,l.style.display="inline-block"):(s.textContent="",l.style.display="none"),p&&(p.style.display="none"),g()}),l.addEventListener("click",()=>{i.value="",d=null,s.textContent="",l.style.display="none",p&&(p.style.display="none"),g()}),c.addEventListener("click",async()=>{if(!f||!d){e("Please select both a base backup file and a ZIP file.",!0),p&&(p.textContent="Error: Both base backup and ZIP file are required.",p.className="status error",p.style.display="block");return}q.isNativePlatform()&&Y.impact({style:J.Light}),p&&(p.style.display="none"),t(!0);const m=a.value.trim(),h=u.checked;try{const y=await f.text();let x=JSON.parse(y);(!x.revisions||x.revisions.length===0)&&(x.revisions=[{number:1,date:Date.now(),book_progresses:[],statuses:[{code:"1",title:"Todo",color:-2697255,ranking:1}],scenes:[],sections:[]}]);const B=x.revisions[0];B.scenes||(B.scenes=[]),B.sections||(B.sections=[]);const C=await JSZip.loadAsync(d),E=[];C.forEach((L,S)=>{!S.dir&&S.name.toLowerCase().endsWith(".txt")&&E.push(S.async("string").then(A=>({name:S.name,text:A})))});const P=await Promise.all(E);if(P.sort((L,S)=>L.name.localeCompare(S.name,void 0,{numeric:!0,sensitivity:"base"})),P.length===0)throw e("No .txt files found in the ZIP archive.",!0),new Error("No .txt files in ZIP.");let w=0;B.scenes.forEach(L=>{L.ranking>w&&(w=L.ranking)}),B.sections.forEach(L=>{L.ranking>w&&(w=L.ranking)});let k=0;for(const L of P){const S=w+1+k,A=`scene${S}`,z=`section${S}`;let _;const F=L.name.replace(/\.txt$/i,"");h?m?F.toLowerCase().startsWith(m.toLowerCase())?_=F:_=`${m}${F}`:_=F:_=m?`${m}${S}`:`Chapter ${S}`;const T=L.text,O=T.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(/\n{2,}/).map(W=>W.trim()).filter(W=>W!==""),Z=[];for(let W=0;W<O.length;W++)Z.push({type:"text",align:"left",text:O[W]}),(W<O.length-1||O.length===0)&&Z.push({type:"text",align:"left"});O.length===0&&(T.trim()===""&&T.length>0?Z.push({type:"text",align:"left"}):T.trim()===""&&Z.push({type:"text",align:"left",text:""})),Z.length===0&&Z.push({type:"text",align:"left",text:""});const le=JSON.stringify({blocks:Z});B.scenes.push({code:A,title:_,text:le,ranking:S,status:"1"}),B.sections.push({code:z,title:_,synopsis:"",ranking:S,section_scenes:[{code:A,ranking:1}]}),k++}const b=Date.now();x.last_update_date=b,x.last_backup_date=b,B.date=b;let I=0;if(B.scenes.forEach(L=>{try{JSON.parse(L.text).blocks.forEach(A=>{A.type==="text"&&typeof A.text=="string"&&A.text.trim()&&(I+=A.text.trim().split(/\s+/).length)})}catch(S){console.warn("Word count parse error for scene:",L.title,S)}}),B.book_progresses&&B.book_progresses.length>0){const L=B.book_progresses[B.book_progresses.length-1];L.word_count=I;const S=new Date;L.year===S.getFullYear()&&L.month===S.getMonth()+1&&L.day===S.getDate()||B.book_progresses.push({year:S.getFullYear(),month:S.getMonth()+1,day:S.getDate(),word_count:I})}else B.book_progresses||(B.book_progresses=[]),B.book_progresses.push({year:new Date().getFullYear(),month:new Date().getMonth()+1,day:new Date().getDate(),word_count:I});const $=new Blob([JSON.stringify(x,null,2)],{type:"application/json"}),N=`${x.title.replace(/[^a-z0-9_\-\s]/gi,"_").replace(/\s+/g,"_")||"augmented_backup"}.json`;await ve($,N,"application/json",e),p&&(p.textContent=`Backup augmented with ${P.length} chapter(s) from ZIP. Download started.`,p.className="status success",p.style.display="block"),e(`Backup augmented successfully with ${P.length} chapters.`)}catch(y){console.error("Augment Backup with ZIP Error:",y),p&&(p.textContent=`Error: ${y.message||"Could not augment backup."}`,p.className="status error",p.style.display="block"),e(`Error: ${y.message||"Could not augment backup."}`,!0)}finally{t(!1)}})}let R=null,v={scene:0,block:0,offset:0},X=null;function we(e,t){if(e)if(t){const n=t.matchLine;let r=n;const o=n.indexOf(t.matchedText);if(o!==-1){const i=ke(n.substring(0,o)),s=`<span class="fr-match-highlight">${ke(n.substring(o,o+t.matchLength))}</span>`,l=ke(n.substring(o+t.matchLength));r=i+s+l}else r=ke(n);e.innerHTML=`Match in "${ke(t.chapterTitle)}":<br>${r.replace(/\n/g,"<br>")}`}else e.innerHTML="No further matches found."}function ke(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function gt(e,t,n){if(!R||!R.revisions||!R.revisions[0]||!R.revisions[0].scenes)return console.error("FindNext: frData or scenes array is missing/invalid."),null;const r=R.revisions[0].scenes;if((typeof v.scene!="number"||v.scene<0)&&(v={scene:0,block:0,offset:0}),v.scene>=r.length)return null;for(let o=v.scene;o<r.length;o++){const i=r[o];if(!i)return console.warn(`FindNext: Scene at index ${o} is undefined. Advancing pointer.`),v={scene:r.length,block:0,offset:0},null;const s=i.text;if(typeof s!="string"){o===v.scene&&(v.block=0,v.offset=0);continue}let l;try{l=JSON.parse(s),Array.isArray(l.blocks)||(l.blocks=[])}catch(u){console.warn(`FindNext: Skipping scene "${i.title||"Untitled"}" (index ${o}) due to invalid JSON:`,u.message),o===v.scene&&(v.block=0,v.offset=0);continue}const a=l.blocks;for(let u=o===v.scene?v.block:0;u<a.length;u++){const c=a[u];if(!c||c.type!=="text"){o===v.scene&&u===v.block&&(v.offset=0,v.block=u+1);continue}const p=c.text||"";let f=0;if(o===v.scene&&u===v.block&&(f=v.offset),f>=p.length&&p.length>0){o===v.scene&&u===v.block&&(v.offset=0);continue}if(!p&&e){o===v.scene&&u===v.block&&(v.offset=0);continue}let d=-1,g="";if(p||t&&!e)if(t)try{if(e==null)return n("Regex pattern is undefined.",!0),null;const m=new RegExp(e,"g");m.lastIndex=f;const h=m.exec(p);h&&(d=h.index,g=h[0])}catch{return n("Invalid regular expression.",!0),null}else e&&(d=p.indexOf(e,f),d!==-1&&(g=e));if(d!==-1){const m=p.split(`
`);let h=0,y="";for(const x of m){if(d>=h&&d<h+x.length+1){y=x;break}h+=x.length+1}return X={sceneIndex:o,blockIndex:u,matchIndex:d,matchLength:g.length,chapterTitle:i.title,matchLine:y,matchedText:g},v={scene:o,block:u,offset:d+g.length},X}o===v.scene&&u===v.block&&(v.offset=0)}o===v.scene&&(v.block=0,v.offset=0)}return v={scene:r.length,block:0,offset:0},null}function Lr(e,t,n){if(!R||!R.revisions||!R.revisions[0]||!R.revisions[0].scenes)return console.error("FindPrev: frData or scenes array is missing/invalid."),null;const r=R.revisions[0].scenes;if(typeof v.scene!="number"||v.scene>=r.length)if(r.length>0){const o=r[r.length-1];let i=0,s=0;try{const l=JSON.parse(o.text);if(l.blocks&&l.blocks.length>0){i=l.blocks.length-1;const a=l.blocks[i];a&&a.type==="text"&&a.text&&(s=a.text.length)}}catch{}v={scene:r.length-1,block:i,offset:s}}else return null;if(v.scene<0)return null;for(let o=v.scene;o>=0;o--){const i=r[o];if(!i)return console.warn(`FindPrev: Scene at index ${o} is undefined. Advancing pointer.`),v={scene:-1,block:0,offset:0},null;const s=i.text;if(typeof s!="string"){o===v.scene&&(v.block=0,v.offset=0);continue}let l;try{l=JSON.parse(s),Array.isArray(l.blocks)||(l.blocks=[])}catch(c){console.warn(`FindPrev: Skipping scene "${i.title||"Untitled"}" (index ${o}) due to invalid JSON:`,c.message),o===v.scene&&(v.block=0,v.offset=0);continue}const a=l.blocks;if(a.length===0){o===v.scene&&(v.block=0,v.offset=0);continue}let u;if(o<v.scene)u=a.length-1;else if(u=v.block,u>=a.length&&(u=a.length-1),u<0){o===v.scene&&(v.block=-1,v.offset=0);continue}for(let c=u;c>=0;c--){const p=a[c];if(!p||p.type!=="text"){o===v.scene&&c===v.block&&(v.offset=0);continue}const f=p.text||"";let d;if(o===v.scene&&c===v.block?d=v.offset:d=f.length,d<=0&&f.length>0){o===v.scene&&c===v.block&&(v.offset=0);continue}if(!f&&e){o===v.scene&&c===v.block&&(v.offset=0);continue}let g=-1,m="";if(f||t&&!e){if(t)try{if(e==null)return n("Regex pattern is undefined.",!0),null;const h=new RegExp(e,"g");let y=null,x;for(;(x=h.exec(f))!==null&&x.index<d;){y=x;if(h.lastIndex===x.index&&e)h.lastIndex++;else if(h.lastIndex===x.index&&!e)break}y&&(g=y.index,m=y[0])}catch{return n("Invalid regular expression.",!0),null}else if(e&&d>0){let h=d;e.length>0?h=d-e.length:h=d-1,h>=0&&(g=f.lastIndexOf(e,h)),g!==-1&&(m=e)}}if(g!==-1){const h=f.split(`
`);let y=0,x="";for(const B of h){if(g>=y&&g<y+B.length+1){x=B;break}y+=B.length+1}return X={sceneIndex:o,blockIndex:c,matchIndex:g,matchLength:m.length,chapterTitle:i.title,matchLine:x,matchedText:m},v={scene:o,block:c,offset:g},X}o===v.scene&&c===v.block&&(v.offset=0)}o===v.scene&&(v.block=-1,v.offset=0)}return v={scene:-1,block:0,offset:0},null}function Pr(e,t){const n=document.getElementById("frBackupFile"),r=document.getElementById("frBackupFileName"),o=document.getElementById("clearFrBackupFile"),i=document.getElementById("findPattern"),s=document.getElementById("useRegexBackup"),l=document.getElementById("currentMatchDisplay"),a=document.getElementById("replaceText"),u=document.getElementById("findNextBtn"),c=document.getElementById("findPreviousBtn"),p=document.getElementById("replaceNextBtn"),f=document.getElementById("replaceAllBtn"),d=document.getElementById("statusFindReplaceBackup");if(!n||!r||!o||!i||!s||!l||!a||!u||!c||!p||!f){console.error("Find & Replace Backup: One or more UI elements not found. Initialization failed.");return}function g(){R=null,X=null,v={scene:0,block:0,offset:0},we(l,null),d&&(d.style.display="none")}n.addEventListener("change",m=>{const h=m.target;if(g(),!h.files||!h.files.length){r.textContent="",o&&(o.style.display="none");return}r.textContent=`Selected: ${h.files[0].name}`,o&&(o.style.display="inline-block"),t(!0);const y=new FileReader;y.onload=x=>{var B;try{if(R=JSON.parse((B=x.target)==null?void 0:B.result),!R.revisions||!R.revisions[0]||!Array.isArray(R.revisions[0].scenes))throw new Error("Invalid backup structure for Find & Replace (missing scenes array).");e("Backup file loaded for Find & Replace.")}catch(C){e(C.message||"Error loading F&R backup.",!0),d&&(d.textContent=`Error: ${C.message||"Could not load backup."}`,d.className="status error",d.style.display="block"),g(),r.textContent="",o&&(o.style.display="none"),n.value="",console.error("F&R Load Error:",C)}finally{t(!1)}},y.onerror=()=>{e("Error reading F&R backup file.",!0),d&&(d.textContent="Error: Could not read backup file.",d.className="status error",d.style.display="block"),g(),r.textContent="",o&&(o.style.display="none"),n.value="",t(!1)},y.readAsText(h.files[0])}),o.addEventListener("click",()=>{n.value="",r.textContent="",o.style.display="none",g()}),u.addEventListener("click",()=>{if(q.isNativePlatform()&&Y.impact({style:J.Light}),d&&(d.style.display="none"),!R){e("Upload a backup file first for Find & Replace.",!0);return}const m=i.value,h=s.checked;if(!m&&!h){e("Enter a find pattern.",!0);return}const y=gt(m,h,e);we(l,y),!y&&R&&R.revisions[0]&&v.scene>=R.revisions[0].scenes.length&&e("Reached end of document.",!1)}),c.addEventListener("click",()=>{if(q.isNativePlatform()&&Y.impact({style:J.Light}),d&&(d.style.display="none"),!R){e("Upload a backup file first for Find & Replace.",!0);return}const m=i.value,h=s.checked;if(!m&&!h){e("Enter a find pattern.",!0);return}const y=Lr(m,h,e);we(l,y),!y&&v.scene<0&&e("Reached beginning of document.",!1)}),p.addEventListener("click",()=>{if(q.isNativePlatform()&&Y.impact({style:J.Light}),d&&(d.style.display="none"),!R||!X){e('No current match to replace. Use "Find Next" first.',!0);return}try{const m=a.value,h=R.revisions[0].scenes[X.sceneIndex],y=JSON.parse(h.text),x=y.blocks[X.blockIndex];if(x.type!=="text"||typeof x.text!="string"){e("Cannot replace in non-text block.",!0);return}const B=x.text||"",C=B.substring(0,X.matchIndex),E=B.substring(X.matchIndex+X.matchLength);x.text=C+m+E,h.text=JSON.stringify(y),e("Match replaced.",!1),v={scene:X.sceneIndex,block:X.blockIndex,offset:X.matchIndex+m.length},X=null;const P=i.value,w=s.checked,k=gt(P,w,e);we(l,k),!k&&R.revisions[0]&&v.scene>=R.revisions[0].scenes.length&&e("Reached end of document.",!1)}catch(m){e(m.message||"Error replacing text.",!0),console.error("Replace Next Error:",m)}}),f.addEventListener("click",async()=>{if(q.isNativePlatform()&&Y.impact({style:J.Light}),d&&(d.style.display="none"),!R){e("Upload a backup file first.",!0);return}const m=i.value,h=a.value,y=s.checked;if(!m&&!y){e("Enter a find pattern.",!0);return}t(!0);try{const x=R.revisions[0];let B=!1;const C=y?new RegExp(m,"g"):null;x.scenes.forEach(k=>{try{const b=JSON.parse(k.text);b.blocks.forEach(I=>{if(I.type==="text"&&typeof I.text=="string"){const $=I.text;y&&C?I.text=I.text.replace(C,h):!y&&m.length>0?I.text=I.text.split(m).join(h):!y&&m.length,I.text!==$&&(B=!0)}}),k.text=JSON.stringify(b)}catch(b){console.warn(`Error processing scene "${k.title}" during Replace All:`,b)}});const E=Date.now();R.last_update_date=E,R.last_backup_date=E,x&&(x.date=E);const P=new Blob([JSON.stringify(R,null,2)],{type:"application/json"}),w=`${R.title.replace(/[^a-z0-9_\-\s]/gi,"_").replace(/\s+/g,"_")||"replaced_backup"}.json`;await ve(P,w,"application/json",e),e(B?"Replace All complete. Content updated. Download started.":"Replace All complete. No changes made (pattern not found or replacement is same). Download started."),X=null,v={scene:0,block:0,offset:0},we(l,null)}catch(x){e(x.message||"Error during Replace All.",!0),console.error("Replace All Error:",x)}finally{t(!1)}})}var We;(function(e){e.Dark="DARK",e.Light="LIGHT",e.Default="DEFAULT"})(We||(We={}));var yt;(function(e){e.None="NONE",e.Slide="SLIDE",e.Fade="FADE"})(yt||(yt={}));const vt=ye("StatusBar"),bt=ye("App",{web:()=>Je(()=>import("./web-BZ1wVmiO.js"),[]).then(e=>new e.AppWeb)}),V={splitter:{elementId:"splitterApp",title:"EPUB Chapter Splitter"},zipToEpub:{elementId:"zipToEpubApp",title:"ZIP to EPUB Converter"},epubToZip:{elementId:"epubToZipApp",title:"EPUB to ZIP (TXT)"},createBackupFromZip:{elementId:"createBackupFromZipApp",title:"Create Backup from ZIP"},createNewBackup:{elementId:"createNewBackupApp",title:"Create New Backup File"},extendBackup:{elementId:"extendBackupApp",title:"Extend Existing Backup File"},mergeBackup:{elementId:"mergeBackupApp",title:"Merge Backup Files"},augmentBackupWithZip:{elementId:"augmentBackupWithZipApp",title:"Augment Backup with ZIP"},findReplaceBackup:{elementId:"findReplaceBackupApp",title:"Find & Replace in Backup File"}};window.toggleMenu=()=>{q.isNativePlatform()&&Y.impact({style:J.Light}),ge()};window.launchAppFromCard=e=>{q.isNativePlatform()&&Y.impact({style:J.Light}),Ae(e,!1,V)};window.showDashboard=()=>{q.isNativePlatform()&&Y.impact({style:J.Light}),re(!1,V)};function $r(){"serviceWorker"in navigator&&navigator.serviceWorker.register("./service-worker.js").then(e=>{console.log("Service Worker registered with scope:",e.scope)}).catch(e=>{console.error("Service Worker registration failed:",e)})}function Fr(){$r();const e=document.getElementById("spinnerSplitter"),t=document.getElementById("spinnerZipToEpub"),n=document.getElementById("spinnerEpubToZip"),r=document.getElementById("spinnerCreateBackupFromZip"),o=document.getElementById("spinnerCreateNewBackup"),i=document.getElementById("spinnerExtendBackup"),s=document.getElementById("spinnerMergeBackup"),l=document.getElementById("spinnerAugmentBackup"),a=document.getElementById("spinnerFindReplaceBackup");sr(te,c=>ne(e,c)),cr(te,c=>ne(t,c)),Er(te,c=>ne(n,c)),wr(te,c=>ne(r,c)),kr(te,c=>ne(o,c)),Ir(te,c=>ne(i,c)),Br(te,c=>ne(s,c)),Sr(te,c=>ne(l,c)),Pr(te,c=>ne(a,c)),document.addEventListener("touchstart",Xt,{passive:!0}),document.addEventListener("touchmove",Yt,{passive:!1}),document.addEventListener("touchend",Gt),q.isNativePlatform()&&(vt.setStyle({style:We.Dark}).catch(c=>console.error("StatusBar.setStyle error:",c)),vt.setBackgroundColor({color:"#111111"}).catch(c=>console.error("StatusBar.setBackgroundColor error:",c)),bt.addListener("backButton",({canGoBack:c})=>{const p=document.getElementById("sidebar");p!=null&&p.classList.contains("open")?ge():window.location.hash!=="#dashboard"&&window.location.hash!==""?re(!1,V):bt.exitApp()}).catch(c=>console.error("App.addListener(backButton) error:",c)));function u(c){const p=window.location.hash;if(console.log(`Routing based on hash: '${p}', fromPopStateUpdate: ${c}`),p.startsWith("#tool-")){const f=p.substring(6);V[f]?Ae(f,c,V):(console.warn(`Invalid tool ID in hash: ${f}. Defaulting to dashboard.`),re(c,V))}else p==="#dashboard"||p===""||console.warn(`Unknown hash: ${p}. Defaulting to dashboard.`),re(c,V)}if(window.addEventListener("popstate",c=>{console.log("MAIN: Popstate event. State:",c.state,"Current Hash:",window.location.hash),u(!0)}),window.location.protocol==="blob:")console.log("MAIN: Initial load from blob URL. Showing dashboard directly."),re(!0,V);else if(window.location.hash)console.log("MAIN: Initial load with hash:",window.location.hash),u(!0);else{const c=sessionStorage.getItem("activeToolId");c&&V[c]?(console.log(`MAIN: Initial load, no hash, persisted tool: ${c}`),Ae(c,!1,V)):(console.log("MAIN: Initial load, no hash, no persisted tool. Showing dashboard."),re(!1,V))}}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/document.addEventListener("DOMContentLoaded",()=>{Fr()});export{lt as E,J as I,st as N,xt as W,zt as b};
